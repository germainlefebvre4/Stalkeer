# Task 1.3: Database Schema & GORM Setup

**Phase**: 1 (Foundation)  
**Complexity**: Medium  
**Status**: Not Started

## Description

Design and implement PostgreSQL schema with GORM models, migrations, and database connection pooling.

## Details

- Create GORM models in `/internal/models`:
  - `PlaylistItem`: id, tvg_name, group_title, tvg_logo, stream_url, content_type, season, episode, resolution, created_at, updated_at, override_by, override_at
  - `FilterConfig`: id, name, group_title (JSON), tvg_name (JSON), is_runtime, created_at, updated_at
  - `ProcessingLog`: id, action, item_count, status, started_at, completed_at, error_message

- Implement database package with:
  - Connection initialization with DSN from config
  - Connection pool configuration (max connections, idle timeout)
  - Auto-migration for GORM models
  - Health check function

- Create indexes:
  - Composite: `(group_title, tvg_name)`
  - Single: `content_type`, `created_at`
  - Single: `is_runtime` on FilterConfig for runtime filter queries

- Implement transaction support for multi-step operations

- Create database setup documentation for developers

## Tables

### Table: `processed_lines`

**Purpose**: Stores original M3U playlist lines and tracks their processing state with polymorphic relationships to content types.

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | Unique identifier |
| `line_content` | Text | NOT NULL | - | Original M3U EXTINF line content |
| `line_url` | Text | NULLABLE | - | Stream URL from M3U |
| `line_hash` | String(64) | NOT NULL, UNIQUE | - | SHA1 hash for deduplication |
| `tvg_name` | String(255) | NOT NULL | - | Original TVG name from M3U |
| `group_title` | String(255) | NOT NULL | - | Original group title from M3U |
| `processed_at` | Timestamp | NOT NULL | CURRENT_TIMESTAMP | When line was processed |
| `content_type` | String(20) | NOT NULL, ENUM | - | Content category: `movies`, `tvshows`, `channels`, `uncategorized` |
| `channel_id` | Integer | FOREIGN KEY → `channels.id`, NULLABLE | NULL | Reference to channels table |
| `movie_id` | Integer | FOREIGN KEY → `movies.id`, NULLABLE | NULL | Reference to movies table |
| `tvshow_id` | Integer | FOREIGN KEY → `tvshows.id`, NULLABLE | NULL | Reference to tvshows table |
| `uncategorized_id` | Integer | FOREIGN KEY → `uncategorized.id`, NULLABLE | NULL | Reference to uncategorized table |
| `download_info_id` | Integer | FOREIGN KEY → `download_info.id`, NULLABLE | NULL | Reference to download tracking |
| `state` | String(50) | NOT NULL, ENUM | `processed` | Processing state: `processed`, `pending`, `downloading`, `downloaded`, `failed` |
| `created_at` | Timestamp | NOT NULL | CURRENT_TIMESTAMP | Record creation time |
| `updated_at` | Timestamp | NOT NULL | CURRENT_TIMESTAMP | Record last update time |
| `overrides_id` | Integer | FOREIGN KEY → `processed_lines.id`, NULLABLE | NULL | Self-reference for version history |
| `overrides_at` | Timestamp | NULLABLE | - | When override occurred |

**Indexes**:
- `idx_processed_lines_hash` on `line_hash`
- `idx_processed_lines_content` on `(content_type, state)`
- `idx_processed_lines_m3u` on `(group_title, tvg_name)`
- `idx_processed_lines_download` on `download_info_id`

**Foreign Key Actions**:
- ON DELETE CASCADE: `channel_id`, `movie_id`, `tvshow_id`, `uncategorized_id`
- ON DELETE SET NULL: `download_info_id`, `overrides_id`

**Key Features**:
- **Line deduplication**: `line_hash` ensures unique M3U entries using SHA1
- **Polymorphic design**: Single table stores relationships to all content types
- **History tracking**: `overrides_id` maintains version history
- **State management**: Tracks processing and download states

---

### Table: `tvshows`

**Purpose**: Stores TV show metadata from TMDB with season/episode information extracted from M3U data.

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | Unique identifier |
| `tmdb_id` | Integer | NOT NULL | - | TMDB database ID |
| `tmdb_title` | String(255) | NOT NULL | - | Show title from TMDB |
| `tmdb_year` | Integer | NOT NULL | - | First air date year from TMDB |
| `tmdb_genres` | Text | NULLABLE | - | Genres as JSON array |
| `season` | Integer | NULLABLE | - | Season number (from M3U parsing) |
| `episode` | Integer | NULLABLE | - | Episode number (from M3U parsing) |
| `created_at` | Timestamp | NOT NULL | CURRENT_TIMESTAMP | Record creation time |
| `updated_at` | Timestamp | NOT NULL | CURRENT_TIMESTAMP | Record last update time |

**Indexes**:
- `idx_tvshows_tmdb` on `tmdb_id`
- `idx_tvshows_season_episode` on `(season, episode)`

**Unique Constraints**:
- `(tmdb_title, tmdb_year, season, episode)` - Prevents duplicate episodes

**Key Features**:
- **TMDB integration**: Stores normalized metadata from TMDB API
- **Episode tracking**: Season and episode numbers extracted from M3U titles
- **Data separation**: M3U-specific fields stored in `processed_lines` (accessible via `raw` attribute in API)
- **Unique episodes**: Prevents duplicate entries for same show/season/episode

---

### Table: `movies`

**Purpose**: Stores movie metadata from TMDB with deduplication based on title and year.

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | Unique identifier |
| `tmdb_id` | Integer | NOT NULL | - | TMDB database ID |
| `tmdb_title` | String(255) | NOT NULL | - | Movie title from TMDB |
| `tmdb_year` | Integer | NOT NULL | - | Release year from TMDB |
| `tmdb_genres` | Text | NULLABLE | - | Genres as JSON array |
| `duration` | Integer | NULLABLE | - | Duration in minutes from TMDB |
| `created_at` | Timestamp | NOT NULL | CURRENT_TIMESTAMP | Record creation time |
| `updated_at` | Timestamp | NOT NULL | CURRENT_TIMESTAMP | Record last update time |

**Indexes**:
- `idx_movies_tmdb` on `tmdb_id`
- `idx_movies_year` on `tmdb_year`

**Unique Constraints**:
- `(tmdb_title, tmdb_year)` - Prevents duplicate movies

**Key Features**:
- **TMDB integration**: Stores normalized metadata from TMDB API
- **Data separation**: M3U-specific fields stored in `processed_lines` (accessible via `raw` attribute in API)
- **Deduplication**: Unique constraint on title and year prevents duplicates
- **Polymorphic relationships**: Related to `download_infos` and `processed_lines`

## Dependencies

- Task 1.1 (Project structure)
- Task 1.2 (Configuration management)

## Acceptance Criteria

- [ ] All PostgreSQL tables created correctly with proper column types
- [ ] GORM models properly annotated with tags
- [ ] Migrations run successfully on fresh database
- [ ] Indexes created and improve query performance
- [ ] Test data inserts succeed
- [ ] Queries return expected results
- [ ] Connection pooling configured and working
- [ ] Database health check endpoint functional
