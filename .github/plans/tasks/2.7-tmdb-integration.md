# Task 2.7: TMDB Integration & Content Enrichment

**Phase**: 2 (Core Functionality)  
**Complexity**: Large  
**Status**: Not Started

## Description

Implement TMDB (The Movie Database) API integration to enrich parsed M3U playlist items with authoritative metadata including titles, years, posters, overviews, genres, and additional information for movies and TV shows.

## Details

### 1. TMDB API Client (`/internal/tmdb/`)

Create a robust TMDB API client with:

- **Configuration**:
  - API key management from config/environment variables
  - Base URL configuration (`https://api.themoviedb.org/3`)
  - Rate limiting (40 requests per 10 seconds as per TMDB limits)
  - Request timeout configuration (default: 10s)
  - Retry logic with exponential backoff
  - Circuit breaker pattern for API failures

- **Search Methods**:
  ```go
  // SearchMovie searches for movies by title and optional year
  func (c *Client) SearchMovie(ctx context.Context, title string, year *int) ([]MovieSearchResult, error)
  
  // SearchTVShow searches for TV shows by title and optional year
  func (c *Client) SearchTVShow(ctx context.Context, title string, year *int) ([]TVShowSearchResult, error)
  
  // GetMovieDetails retrieves detailed movie information by TMDB ID
  func (c *Client) GetMovieDetails(ctx context.Context, tmdbID int) (*MovieDetails, error)
  
  // GetTVShowDetails retrieves detailed TV show information by TMDB ID
  func (c *Client) GetTVShowDetails(ctx context.Context, tmdbID int) (*TVShowDetails, error)
  ```

- **Response Models**:
  ```go
  type MovieSearchResult struct {
      ID           int      `json:"id"`
      Title        string   `json:"title"`
      OriginalTitle string  `json:"original_title"`
      ReleaseDate  string   `json:"release_date"`
      PosterPath   *string  `json:"poster_path"`
      Overview     string   `json:"overview"`
      GenreIDs     []int    `json:"genre_ids"`
      Popularity   float64  `json:"popularity"`
  }
  
  type MovieDetails struct {
      ID          int      `json:"id"`
      Title       string   `json:"title"`
      ReleaseDate string   `json:"release_date"`
      PosterPath  *string  `json:"poster_path"`
      Overview    string   `json:"overview"`
      Genres      []Genre  `json:"genres"`
      Runtime     *int     `json:"runtime"`
      Status      string   `json:"status"`
  }
  
  type TVShowSearchResult struct {
      ID           int      `json:"id"`
      Name         string   `json:"name"`
      OriginalName string   `json:"original_name"`
      FirstAirDate string   `json:"first_air_date"`
      PosterPath   *string  `json:"poster_path"`
      Overview     string   `json:"overview"`
      GenreIDs     []int    `json:"genre_ids"`
      Popularity   float64  `json:"popularity"`
  }
  
  type TVShowDetails struct {
      ID           int      `json:"id"`
      Name         string   `json:"name"`
      FirstAirDate string   `json:"first_air_date"`
      PosterPath   *string  `json:"poster_path"`
      Overview     string   `json:"overview"`
      Genres       []Genre  `json:"genres"`
      Status       string   `json:"status"`
      NumberOfSeasons int   `json:"number_of_seasons"`
      NumberOfEpisodes int  `json:"number_of_episodes"`
  }
  
  type Genre struct {
      ID   int    `json:"id"`
      Name string `json:"name"`
  }
  ```

- **Error Handling**:
  - HTTP status code handling (401 unauthorized, 404 not found, 429 rate limit, 5xx server errors)
  - Network error handling with retries
  - JSON parsing errors
  - Custom error types for different failure scenarios

- **Caching Strategy**:
  - In-memory cache for search results (TTL: 24 hours)
  - Cache key: normalized title + year
  - LRU eviction policy (max 10,000 entries)
  - Optional Redis cache for production

### 2. Content Enrichment Service (`/internal/enrichment/`)

Create enrichment orchestration layer:

- **Enrichment Workflow**:
  ```go
  // EnrichPlaylistItem enriches a processed line with TMDB metadata
  func (s *Service) EnrichPlaylistItem(ctx context.Context, line *models.ProcessedLine) error
  ```

- **Matching Logic**:
  - Extract clean title from `tvg_name` (remove brackets, quality tags, etc.)
  - Parse year from title if present (e.g., "Movie Title (2023)")
  - Use content type from classification to determine movie vs TV show search
  - Search TMDB with cleaned title and year
  - Select best match based on:
    - Exact title match (highest priority)
    - Year match (if available)
    - Popularity score (for tie-breaking)
    - Levenshtein distance for fuzzy matching

- **Data Mapping**:
  - For Movies:
    - Create or update `Movie` record with TMDB data
    - Store: tmdb_id, tmdb_title, tmdb_year, tmdb_genres (JSON), duration
    - Link to `ProcessedLine` via movie_id foreign key
  - For TV Shows:
    - Create or update `TVShow` record with TMDB data
    - Store: tmdb_id, tmdb_title, tmdb_year, tmdb_genres (JSON), season, episode
    - Season/episode from M3U parsing (Task 2.2)
    - Link to `ProcessedLine` via tvshow_id foreign key

- **Deduplication**:
  - Check existing Movie/TVShow by (tmdb_title, tmdb_year) before creating
  - Update existing records if TMDB data changed
  - Reuse existing records for multiple ProcessedLines

- **Batch Processing**:
  - Process items in batches (configurable, default: 50)
  - Respect TMDB rate limits
  - Progress tracking and logging
  - Resume capability after interruption

### 3. Configuration Updates

Add to `config.yml`:
```yaml
tmdb:
  api_key: "your_tmdb_api_key_here"
  base_url: "https://api.themoviedb.org/3"
  timeout: 10s
  rate_limit:
    requests_per_10s: 40
  cache:
    enabled: true
    ttl: 24h
    max_entries: 10000
  retry:
    max_attempts: 3
    initial_delay: 1s
    max_delay: 30s
```

Environment variable support:
- `STALKEER_TMDB_API_KEY`
- `TMDB_API_KEY` (alternative)

### 4. CLI Integration

Add enrichment command:
```bash
# Enrich all processed items missing TMDB data
stalkeer enrich

# Enrich specific content type
stalkeer enrich --content-type movies
stalkeer enrich --content-type tvshows

# Force re-enrichment of existing data
stalkeer enrich --force

# Dry run mode
stalkeer enrich --dry-run

# Enrich items from specific group
stalkeer enrich --group-title "Movies HD"
```

### 5. API Endpoints

Add enrichment endpoints:
```
POST /api/v1/enrich           # Trigger enrichment for all items
POST /api/v1/enrich/movies    # Enrich only movies
POST /api/v1/enrich/tvshows   # Enrich only TV shows
GET  /api/v1/enrich/status    # Get enrichment job status
```

Response models:
```json
{
  "job_id": "enrich-20260129-123456",
  "status": "running",
  "progress": {
    "total": 1000,
    "processed": 350,
    "enriched": 320,
    "failed": 30,
    "skipped": 0
  },
  "started_at": "2026-01-29T12:34:56Z",
  "estimated_completion": "2026-01-29T12:45:00Z"
}
```

### 6. Testing Strategy

- **Unit Tests**:
  - TMDB client request building
  - Response parsing
  - Error handling for various HTTP status codes
  - Rate limiting logic
  - Cache hit/miss scenarios
  - Matching algorithm accuracy
  
- **Integration Tests**:
  - Real TMDB API calls (with test API key)
  - End-to-end enrichment workflow
  - Database updates verification
  - Batch processing
  
- **Mock Tests**:
  - Mock TMDB responses for consistent tests
  - Test network failures
  - Test rate limit handling
  - Test circuit breaker behavior
  
- **Performance Tests**:
  - Enrich 1000 items benchmark
  - Cache performance measurement
  - Rate limiting effectiveness
  - Concurrent request handling

### 7. Monitoring & Logging

- **Metrics**:
  - TMDB API request count
  - Cache hit/miss ratio
  - Average enrichment time per item
  - Success/failure rates
  - Rate limit violations

- **Logging**:
  - Log enrichment start/completion
  - Log API errors with context
  - Log matching decisions (title match, year match, etc.)
  - Log cache operations at debug level
  - Progress updates every 100 items

### 8. Error Scenarios & Handling

| Scenario | Action |
|----------|--------|
| TMDB API key missing | Return clear error, don't start enrichment |
| TMDB API returns 401 | Log error, stop enrichment, alert user |
| TMDB API returns 404 | Mark item as "not found", continue processing |
| TMDB API returns 429 | Wait according to Retry-After header, resume |
| Network timeout | Retry with exponential backoff, max 3 attempts |
| No match found | Log warning, mark item state, continue |
| Multiple matches | Select best match, log decision, continue |
| JSON parsing error | Log error with response body, skip item |
| Rate limit exceeded | Pause processing, wait, resume automatically |

## Dependencies

- Task 1.3 (Database schema) - Movies and TVShows tables must exist
- Task 2.1 (M3U parser) - Items must be parsed before enrichment
- Task 2.2 (Content classification) - Content type must be classified

## Acceptance Criteria

- [ ] TMDB API client successfully searches for movies and TV shows
- [ ] API client respects rate limits (40 requests per 10 seconds)
- [ ] Retry logic with exponential backoff implemented
- [ ] Circuit breaker prevents cascading failures
- [ ] Search results cached appropriately
- [ ] Enrichment service maps TMDB data to database models
- [ ] Matching algorithm selects correct TMDB entry (>90% accuracy on test set)
- [ ] Movies table populated with TMDB metadata
- [ ] TVShows table populated with TMDB metadata
- [ ] Deduplication prevents duplicate Movie/TVShow records
- [ ] Batch processing handles large datasets efficiently
- [ ] CLI command enriches all processed items
- [ ] API endpoints trigger and report enrichment status
- [ ] Configuration supports API key from env or config file
- [ ] Error handling covers all TMDB API error scenarios
- [ ] Unit tests cover TMDB client, enrichment service, matching logic
- [ ] Integration tests verify end-to-end enrichment workflow
- [ ] Performance benchmark: enrich 1000 items in <5 minutes
- [ ] Documentation includes TMDB API key setup instructions
- [ ] Logging provides visibility into enrichment progress
- [ ] Metrics track enrichment success/failure rates

## Implementation Steps

1. **Setup TMDB Client** (2-3 days)
   - Create TMDB client package structure
   - Implement HTTP client with timeout and retry
   - Implement rate limiting
   - Add search and details methods
   - Write unit tests with mocked responses

2. **Build Enrichment Service** (2-3 days)
   - Create enrichment service package
   - Implement matching algorithm
   - Add data mapping logic
   - Implement batch processing
   - Add deduplication logic

3. **Database Integration** (1 day)
   - Update models if needed
   - Test TMDB data storage
   - Verify foreign key relationships
   - Test unique constraints

4. **CLI & API** (1-2 days)
   - Add enrich CLI command
   - Implement API endpoints
   - Add progress reporting
   - Test dry-run mode

5. **Testing & Validation** (2-3 days)
   - Write comprehensive unit tests
   - Create integration tests
   - Performance benchmarking
   - Test with real TMDB API

6. **Documentation** (1 day)
   - API key setup guide
   - Usage examples
   - Troubleshooting guide
   - Update README and docs

## Estimated Timeline

**Total**: 9-13 days (approximately 2 weeks)

## Notes

- TMDB API key is free with registration at https://www.themoviedb.org/settings/api
- TMDB has generous rate limits for free tier (40 req/10s, ~14,400 req/hour)
- Consider implementing poster image download as future enhancement
- Genre IDs can be mapped to names using TMDB genres endpoint
- TMDB data should be refreshed periodically (e.g., monthly) for updated metadata
- Consider adding language preference configuration for international titles
