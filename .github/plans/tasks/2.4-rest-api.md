# Task 2.4: REST API Scaffolding & Content Endpoints

**Phase**: 2 (Core Functionality)  
**Complexity**: Large  
**Status**: Completed

## Description

Implement Gin-based REST API server with core content query endpoints, error handling, and proper pagination.

## Details

- Create API package at `/internal/api/`
- Initialize Gin router with middleware:
  - CORS support for frontend integration
  - Request logging middleware
  - Error handling middleware
  - Request ID tracking

- Implement content endpoints:
  - `GET /api/v1/items` - List items with filtering, sorting, pagination
    - Query params: `limit` (default: 20, max: 1000), `offset` (default: 0)
    - Query params: `sort` (tvg_name, created_at, resolution)
    - Query params: `filter` (apply runtime filters)
    - Query params: `content_type` (movie, tvshow, uncategorized)
    - Response: array of items with total count
  - `GET /api/v1/items/:id` - Get single item by ID
    - Response: full item details
  - `PUT /api/v1/items/:id` - Update item metadata
    - Allows manual override of auto-detected fields
    - Fields: content_type, season, episode, resolution
  - `POST /api/v1/items/search` - Advanced search
    - Query param: `q` (search in tvg_name, group_title)
    - Combined filtering and pagination
  - `GET /api/v1/stats` - Statistics endpoint
    - Count by content_type, resolution, group_title
    - Processing timestamp

- Response DTOs:
  - ItemResponse: JSON serializable representation
  - PaginatedResponse: wraps results with metadata
  - ErrorResponse: structured error format

- Error handling:
  - 400 Bad Request: invalid pagination/filter params
  - 404 Not Found: item not found
  - 500 Internal Server Error: database errors
  - Clear error messages in response

- Validation:
  - Pagination limit enforcement (max 1000)
  - Offset validation (non-negative)
  - Sort field whitelist (prevent injection)

- API documentation:
  - Swagger/OpenAPI comments on handlers
  - Endpoint descriptions and parameter docs

- Unit tests:
  - Mock database for endpoint testing
  - Test pagination boundaries
  - Test error responses
  - Test filtering combinations
  - Concurrent request tests

## Dependencies

- Task 1.1 (Project structure)
- Task 1.3 (Database schema)
- Task 1.4 (Unit test foundation)

## Acceptance Criteria

- [x] All 5+ endpoints respond with correct status codes
- [x] Filtering and sorting working correctly
- [x] Pagination prevents memory exhaustion
- [x] Error responses include helpful messages
- [x] CORS headers properly set
- [ ] Unit test coverage >90% for API layer
- [ ] All endpoints documented with OpenAPI/Swagger

## Completion Notes

- Full Gin router implementation with middleware in `/internal/api/api.go`
- CORS middleware configured with customizable origins, methods, and headers
- Request ID tracking middleware implemented
- Error handling middleware for consistent error responses
- Complete CRUD endpoints for items, movies, TV shows, and filters
- Pagination with configurable limits (default: 20, max: 1000)
- Filtering by content type, state, and group title
- Sorting with field validation (tvg_name, created_at, processed_at, group_title)
- Response DTOs defined in `/internal/api/dto.go`
- Model-to-DTO conversion functions implemented
- Health check endpoint with database connectivity verification
- Statistics endpoint with aggregations by content type, resolution, state, and top groups
- Dry-run endpoint integration
- All endpoints accessible via `/api/v1` route group
- Server command fully functional in CLI

**Future Enhancements:**
- Add comprehensive unit tests for handlers
- Add OpenAPI/Swagger documentation
- Implement request rate limiting
- Add authentication and authorization
