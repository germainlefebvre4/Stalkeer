# Task 3.1: Error Handling & Resilience

**Phase**: 3 (Polish, Integration & Deploy)  
**Complexity**: Medium  
**Status**: Not Started

## Description

Implement comprehensive error handling throughout the application with proper logging, retries, and graceful degradation.

## Details

- Create error package at `/internal/errors/` or extend existing:
  - Define custom error types:
    - `ValidationError` - input validation failures
    - `DatabaseError` - database operation failures
    - `ParseError` - M3U parsing failures
    - `ClassificationError` - content classification failures
    - `ExternalServiceError` - Radarr/Sonarr API failures
    - `ConfigError` - configuration issues
  
  - Implement error wrapping with context
  - Error codes and categorization

- Implement retry logic:
  - Exponential backoff for transient failures
  - Max retry attempts configuration
  - Jitter to prevent thundering herd
  - Specific retry triggers (connection timeout, 429, 5xx errors)

- Implement graceful shutdown:
  - Handle SIGINT, SIGTERM signals
  - Close database connections cleanly
  - Stop in-progress processing
  - Flush pending operations

- Implement structured logging:
  - JSON format for machine parsing
  - Request ID tracking for correlation
  - Log levels: DEBUG, INFO, WARN, ERROR
  - Context injection (user, endpoint, operation)
  - Stacktraces for errors

- Error recovery in M3U parsing:
  - Skip corrupt entries and log details
  - Continue processing after errors
  - Track error statistics per file

- Connection pooling and circuit breaker:
  - Implement circuit breaker pattern for external APIs
  - Monitor connection pool health
  - Fallback strategies

- Unit tests:
  - Test error creation and wrapping
  - Test retry logic with different scenarios
  - Test graceful shutdown handling
  - Test structured logging output

## Dependencies

- All Phase 2 tasks (to retrofit error handling)

## Acceptance Criteria

- [ ] Custom error types defined for all failure scenarios
- [ ] Retry logic functional with exponential backoff
- [ ] Graceful shutdown cleans up resources
- [ ] Structured logging in JSON format with context
- [ ] M3U parser recovers from corrupt entries
- [ ] Error messages helpful for diagnosis
- [ ] Unit tests cover error paths
- [ ] No unhandled panics in production code
