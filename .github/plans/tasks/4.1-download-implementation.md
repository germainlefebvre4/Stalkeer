---
goal: Implement download functionality for missing media from Radarr and Sonarr
version: 2.0
date_created: 2025-01-01
last_updated: 2026-02-03
owner: Backend Team
status: 'In progress'
tags: [feature, download, radarr, sonarr, integration]
---

# Stalkeer Download Implementation Plan

![Status: In progress](https://img.shields.io/badge/status-In_progress-yellow)

## Introduction

Stalkeer needs to download missing media items (movies and TV shows) from M3U playlist direct links after identifying what's missing from Radarr and Sonarr. The system queries external APIs, matches content, downloads files, and manages state throughout the process.

### Success Criteria
- Successfully integrate with Radarr and Sonarr APIs to identify missing media ✅
- Match missing items with M3U playlist items with high accuracy ✅
- Download media files with progress tracking and resume capability ✅
- Handle concurrent downloads with configurable limits ✅
- Store downloaded files in organized directory structure ✅
- Track all download operations in database ✅
- Provide CLI commands to trigger downloads ✅
- Support dry-run mode to preview download actions without executing ✅

### Target Users
- Radarr/Sonarr users who want to automatically fill their media library from M3U playlists
- Users managing large media collections from streaming sources
- Users with bandwidth constraints who need download management

## Technical Approach

### Architecture Components

1. **External Service Integration Layer** (`internal/external/`)
   - Radarr API client: Query missing movies, get movie details
   - Sonarr API client: Query missing episodes, get series details
   - TMDB API client: Enhance matching with metadata (see Task 2.7)

2. **Matching Engine** (`internal/matcher/`)
   - Fuzzy matching algorithm for titles
   - Season/episode number matching for TV shows
   - Quality/resolution matching
   - Confidence scoring system

3. **Download Manager** (`internal/downloader/`)
   - HTTP downloader with resume support
   - Concurrent download pool with limits
   - Progress tracking and callbacks
   - Bandwidth throttling
   - Retry logic with exponential backoff

4. **File Manager** (`internal/filemanager/`)
   - Directory organization (movies vs tvshows)
   - File naming conventions
   - Disk space validation
   - File verification (checksum, size)

### Data Models

**New Models**:
```go
// DownloadTask - Tracks download operations
type DownloadTask struct {
    ID              uint
    PlaylistItemID  uint
    TargetService   string  // "radarr" or "sonarr"
    TargetItemID    string  // Radarr/Sonarr item ID
    FilePath        string
    FileSize        int64
    DownloadedBytes int64
    Status          DownloadStatus
    ErrorMessage    *string
    RetryCount      int
    CreatedAt       time.Time
    StartedAt       *time.Time
    CompletedAt     *time.Time
}

// MatchResult - Stores matching results
type MatchResult struct {
    ID              uint
    PlaylistItemID  uint
    TargetService   string
    TargetItemID    string
    TargetTitle     string
    MatchScore      float64
    IsConfirmed     bool
    CreatedAt       time.Time
}
```

**Extended Configuration**:
```yaml
radarr:
  url: http://localhost:7878
  api_key: your_api_key
  quality_profile_id: 1
  
sonarr:
  url: http://localhost:8989
  api_key: your_api_key
  quality_profile_id: 1

downloads:
  concurrent_limit: 3
  retry_attempts: 3
  retry_delay: 60s
  bandwidth_limit: 10MB  # 0 for unlimited
  timeout: 30m
  verify_downloads: true
  
directories:
  movies: /path/to/movies
  tvshows: /path/to/tvshows
  temp: /path/to/temp
```

### API Endpoints

```
# Missing Items Detection
GET  /api/v1/missing/movies           # List missing movies from Radarr
GET  /api/v1/missing/tvshows          # List missing episodes from Sonarr
POST /api/v1/missing/scan             # Trigger scan for missing items

# Matching
GET  /api/v1/matches                  # List all matches
GET  /api/v1/matches/:id              # Get match details
POST /api/v1/matches/:id/confirm      # Confirm a match
DELETE /api/v1/matches/:id            # Reject a match

# Downloads
GET  /api/v1/downloads                # List all downloads
GET  /api/v1/downloads/:id            # Get download status
POST /api/v1/downloads                # Create download task(s)
PUT  /api/v1/downloads/:id/pause      # Pause download
PUT  /api/v1/downloads/:id/resume     # Resume download
DELETE /api/v1/downloads/:id          # Cancel/delete download
GET  /api/v1/downloads/stats          # Get download statistics

# Settings
GET  /api/v1/settings/radarr          # Get Radarr settings
PUT  /api/v1/settings/radarr          # Update Radarr settings
GET  /api/v1/settings/sonarr          # Get Sonarr settings
PUT  /api/v1/settings/sonarr          # Update Sonarr settings
```

### Technical Decisions

1. **HTTP Client**: Use standard `net/http` with custom transport for bandwidth limiting
2. **Concurrent Downloads**: Use worker pool pattern with `sync.WaitGroup` and channels
3. **Progress Tracking**: Use `io.TeeReader` to track bytes as they're downloaded
4. **Resume Support**: Use HTTP Range headers and append mode for partial downloads
5. **Matching Algorithm**: Levenshtein distance for fuzzy title matching
6. **File Organization**: Follow Radarr/Sonarr naming conventions for compatibility

### Trade-offs

- **Matching Accuracy vs Speed**: Fuzzy matching is slower but more accurate; use caching for repeated lookups
- **Download Speed vs Resource Usage**: Concurrent downloads increase speed but use more memory/bandwidth
- **Storage vs Verification**: File verification adds time but ensures integrity
- **API Polling vs Webhooks**: Polling is simpler but less efficient; implement polling first, webhooks later

## Implementation Plan

## 1. Requirements & Constraints

**Functional Requirements:**
- **REQ-001**: System must integrate with Radarr and Sonarr APIs to fetch missing content
- **REQ-002**: Downloads must support HTTP/HTTPS protocols with resume capability
- **REQ-003**: All download operations must be tracked in database with state management
- **REQ-004**: Downloaded files must be organized in proper directory structures
- **REQ-005**: System must support concurrent downloads with configurable limits
- **REQ-006**: Dry-run mode must preview actions without executing downloads

**Technical Constraints:**
- **CON-001**: Use existing GORM database models and PostgreSQL
- **CON-002**: Maintain compatibility with existing CLI structure (Cobra)
- **CON-003**: File operations must be atomic to prevent corruption
- **CON-004**: Downloads must survive application restarts (resume capability)

**Guidelines:**
- **GUD-001**: Follow Radarr/Sonarr naming conventions for compatibility
- **GUD-002**: Implement comprehensive error handling with retry logic
- **GUD-003**: Provide detailed progress reporting for user feedback

## 2. Implementation Steps

### Phase 1: External Service Integration ✅ COMPLETED

- GOAL-001: Integrate with Radarr and Sonarr APIs for missing content detection

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-001 | Create Radarr API client at `internal/external/radarr/` with authentication, GetMissingMovies(), GetMovieDetails() methods | ✅ | 2025-12-15 |
| TASK-002 | Create Sonarr API client at `internal/external/sonarr/` with authentication, GetMissingSeries(), GetMissingEpisodes() methods | ✅ | 2025-12-15 |
| TASK-003 | Extend Config struct with Radarr/Sonarr settings (base_url, api_key, download paths) | ✅ | 2025-12-10 |
| TASK-004 | Create DownloadInfo model for tracking download operations with status, progress, retry fields | ✅ | 2026-01-20 |
| TASK-005 | Unit tests for Radarr/Sonarr clients with mock HTTP responses | ✅ | 2025-12-20 |

### Phase 2: Matching Engine ✅ COMPLETED

- GOAL-002: Implement content matching between external services and local database

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-006 | Create matcher package at `internal/matcher/` with fuzzy string matching and confidence scoring | ✅ | 2025-12-22 |
| TASK-007 | Implement title normalization to remove special characters, years, and quality tags | ✅ | 2025-12-22 |
| TASK-008 | Create MatchMovie() and MatchEpisode() methods with TMDB ID and title-based matching | ✅ | 2025-12-23 |
| TASK-009 | Enhance classifier with season/episode extraction for formats S01E01, 1x01, Season 1 Episode 1 | ✅ | 2025-11-15 |
| TASK-010 | Comprehensive unit tests for matcher with edge cases and performance benchmarks | ✅ | 2025-12-28 |

### Phase 3: Download Manager ✅ SUBSTANTIALLY COMPLETE

- GOAL-003: Implement robust download system with progress tracking and resume capability

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-011 | Create downloader package with HTTP client, timeout, and retry configuration | ✅ | 2026-01-10 |
| TASK-012 | Implement HTTP Range header support for resumable downloads | ✅ | 2026-02-01 |
| TASK-013 | Add progress tracking with callbacks and state persistence | ✅ | 2026-01-12 |
| TASK-014 | Implement StateManager for download state transitions and locking | ✅ | 2026-02-01 |
| TASK-015 | Create ParallelDownloader with worker pool for concurrent downloads | ✅ | 2026-01-15 |
| TASK-016 | Implement retry logic with exponential backoff in retry package | ✅ | 2025-12-05 |
| TASK-017 | Add disk space validation before downloads | ✅ | 2026-01-18 |
| TASK-018 | Implement file organization with proper directory structures and naming | ✅ | 2026-01-25 |
| TASK-019 | Create path sanitization and extension detection utilities | ✅ | 2026-01-25 |
| TASK-020 | Comprehensive unit tests for downloader components | ✅ | 2026-01-30 |

### Phase 4: Integration & CLI Workflow ✅ SUBSTANTIALLY COMPLETE

- GOAL-004: Provide CLI commands for scanning missing content and triggering downloads

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-021 | Create radarr CLI command with flags (--dry-run, --limit, --parallel, --force, --verbose) | ✅ | 2026-01-28 |
| TASK-022 | Implement radarr workflow: query API, match content, download files, track progress | ✅ | 2026-01-28 |
| TASK-023 | Create sonarr CLI command with flags including --series-id filter | ✅ | 2026-01-28 |
| TASK-024 | Implement sonarr workflow: query API, match episodes, download files, track progress | ✅ | 2026-01-28 |
| TASK-025 | Add dry-run mode support for both commands to preview without downloading | ✅ | 2026-01-28 |
| TASK-026 | Implement detailed progress reporting with download statistics | ✅ | 2026-01-28 |
| TASK-027 | Create resume-downloads CLI command to resume interrupted downloads | ✅ | 2026-02-01 |
| TASK-028 | Implement cleanup command for removing old download records | ✅ | 2026-01-30 |

### Phase 5: Testing & Polish ⏳ IN PROGRESS

- GOAL-005: Ensure production readiness with comprehensive testing and documentation

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-029 | Comprehensive error handling throughout download flow with transaction rollbacks | ✅ | 2026-01-30 |
| TASK-030 | Implement graceful shutdown for in-progress downloads | ✅ | 2025-12-05 |
| TASK-031 | Add circuit breaker pattern for external API failures | ✅ | 2025-12-05 |
| TASK-032 | Performance optimization: connection pooling, caching, batch operations | ✅ | 2026-01-20 |
| TASK-033 | Security validation: API key storage, path traversal prevention, input validation | ⏳ | |
| TASK-034 | Complete integration testing suite for end-to-end workflows | ⏳ | |
| TASK-035 | Load testing with multiple concurrent downloads | ⏳ | |
| TASK-036 | Update documentation: README, API docs, configuration guide, troubleshooting | ⏳ | |
| TASK-037 | Create architecture diagrams and workflow documentation | ⏳ | |

## 3. Alternatives

- **ALT-001**: Use torrent protocol instead of direct HTTP downloads - Rejected due to complexity and legal concerns
- **ALT-002**: Implement REST API for download management instead of CLI - Deferred to future phase, CLI provides immediate value
- **ALT-003**: Store downloads directly in Radarr/Sonarr directories - Rejected to maintain separation of concerns and safer temp directory handling
- **ALT-004**: Use third-party download manager - Rejected to maintain full control over download logic and state management

## 4. Dependencies

- **DEP-001**: Task 1.2 - Configuration Management (Complete)
- **DEP-002**: Task 1.3 - Database Schema (Complete)
- **DEP-003**: Task 2.7 - TMDB Integration (Not Started - Not blocking)
- **DEP-004**: Task 3.1 - Error Handling (Complete)
- **DEP-005**: PostgreSQL database with GORM
- **DEP-006**: HTTP/HTTPS access to M3U playlist sources
- **DEP-007**: Valid Radarr and Sonarr API keys

## 5. Files

**Created:**
- **FILE-001**: `internal/external/radarr/radarr.go` - Radarr API client
- **FILE-002**: `internal/external/sonarr/sonarr.go` - Sonarr API client
- **FILE-003**: `internal/external/tmdb/tmdb.go` - TMDB API client
- **FILE-004**: `internal/matcher/matcher.go` - Content matching engine
- **FILE-005**: `internal/downloader/downloader.go` - HTTP downloader core
- **FILE-006**: `internal/downloader/parallel.go` - Parallel download manager
- **FILE-007**: `internal/downloader/state_manager.go` - Download state management
- **FILE-008**: `internal/downloader/resume.go` - Resume support for downloads
- **FILE-009**: `internal/downloader/resume_helper.go` - Helper utilities for resume
- **FILE-010**: `internal/downloader/path.go` - Path construction and sanitization
- **FILE-011**: `internal/downloader/diskspace.go` - Disk space validation
- **FILE-012**: `internal/downloader/cleanup.go` - Cleanup utilities
- **FILE-013**: `cmd/resume_downloads.go` - Resume downloads CLI command
- **FILE-014**: `cmd/cleanup.go` - Cleanup CLI command

**Modified:**
- **FILE-015**: `cmd/main.go` - Added radarr and sonarr CLI commands
- **FILE-016**: `internal/config/config.go` - Extended with download settings
- **FILE-017**: `internal/models/processing_log.go` - Added DownloadInfo model
- **FILE-018**: `config.yml.example` - Added Radarr/Sonarr configuration examples

## 6. Testing

- **TEST-001**: Unit tests for Radarr API client with mock HTTP responses
- **TEST-002**: Unit tests for Sonarr API client with mock HTTP responses
- **TEST-003**: Unit tests for matcher with various title formats and edge cases
- **TEST-004**: Unit tests for downloader with mock HTTP server
- **TEST-005**: Unit tests for ParallelDownloader with concurrency control
- **TEST-006**: Unit tests for StateManager with state transitions
- **TEST-007**: Unit tests for path utilities with cross-platform compatibility
- **TEST-008**: Unit tests for disk space validation
- **TEST-009**: Integration tests for radarr command end-to-end workflow
- **TEST-010**: Integration tests for sonarr command end-to-end workflow
- **TEST-011**: Performance tests for concurrent downloads
- **TEST-012**: Resume capability tests with interrupted downloads

## 7. Risks & Assumptions

**Risks:**
- **RISK-001**: Radarr/Sonarr API changes could break integration - Medium probability, high impact
- **RISK-002**: Low match accuracy between playlist items and external content - Medium probability, high impact
- **RISK-003**: Network interruptions during downloads - High probability, medium impact (mitigated by resume support)
- **RISK-004**: Disk space exhaustion during downloads - Medium probability, high impact (mitigated by pre-download validation)
- **RISK-005**: Concurrent download crashes due to resource limits - Low probability, medium impact (mitigated by worker pool limits)

**Assumptions:**
- **ASSUMPTION-001**: Radarr and Sonarr APIs are stable and accessible
- **ASSUMPTION-002**: M3U playlist items have direct HTTP/HTTPS download URLs
- **ASSUMPTION-003**: Users have sufficient disk space for downloads
- **ASSUMPTION-004**: Network connectivity is generally reliable
- **ASSUMPTION-005**: Users have valid API keys for Radarr/Sonarr
- **ASSUMPTION-006**: Downloaded files can be moved/renamed after completion

## 8. Related Specifications / Further Reading

- [Task 3.2: Radarr/Sonarr Integration](3.2-radarr-sonarr-integration.md)
- [Task 3.3: Radarr/Sonarr Download Commands](3.3-radarr-sonarr-download-commands.md)
- [Task 4.2: Download Organization Plan](4.2-download-organization-plan.md)
- [Task 4.3: Resume Downloads Implementation](4.3-resume-downloads-implementation.md)
- [Radarr API Documentation](https://radarr.video/docs/api/)
- [Sonarr API Documentation](https://sonarr.tv/docs/api/)
- [HTTP Range Requests RFC](https://tools.ietf.org/html/rfc7233)

### Small Tasks (1-2 days each)
- 1.3: Configuration Extension
- 4.3: Status and Monitoring
- 4.4: Cleanup and Maintenance
- 5.2: Performance Optimization
- 5.3: Documentation

### Medium Tasks (2-3 days each)
- 1.1: Radarr API Client
- 1.2: Sonarr API Client
- 1.4: Database Schema for Downloads
- 2.2: Season/Episode Parser Enhancement
- 2.3: Match Storage and API
- 3.3: File Manager
- 3.4: Download API Endpoints
- 4.1: Missing Items Scanner
- 4.2: Download Workflow
- 5.1: Error Handling & Recovery
- 5.4: Security & Validation
- 5.5: Integration Testing Suite

### Large Tasks (3-5 days each)
- 2.1: Title Matching Algorithm
- 3.1: HTTP Downloader Core
- 3.2: Download Task Manager

**Total Estimated Timeline**: 22-30 days (approximately 4-6 weeks)

---

## Considerations

### Assumptions

- Radarr and Sonarr APIs are stable and accessible
- M3U playlist items have direct HTTP/HTTPS download URLs
- Users have sufficient disk space for downloads
- Network connectivity is generally reliable
- Users have valid API keys for Radarr/Sonarr
- Downloaded files can be moved/renamed after completion

### Constraints

- **Time**: 4-6 weeks for full implementation
- **Technical**: 
  - Go standard library for most functionality
  - Existing GORM database structure
  - RESTful API design patterns
  - CLI must remain responsive during downloads
- **Resource**: 
  - Memory usage scales with concurrent downloads
  - Disk space required for temporary files
  - Network bandwidth shared among concurrent downloads

### Risks & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Radarr/Sonarr API changes | High | Low | Version API calls, implement fallbacks |
| Low match accuracy | High | Medium | Manual confirmation workflow, tunable thresholds |
| Download failures | Medium | High | Retry logic, resume support, error logging |
| Disk space exhaustion | High | Medium | Pre-download validation, configurable limits |
| Network interruptions | Medium | High | Resume support, automatic retry |
| Concurrent download crashes | High | Low | Worker pool limits, graceful error handling |
| Security vulnerabilities | High | Low | Input validation, security audit, HTTPS |

### Performance Targets

- Match 1000 items in < 5 seconds
- Download 3 concurrent streams without degradation
- Resume interrupted download within 10 seconds
- API response time < 200ms for status queries
- Support M3U playlists with 50,000+ items

---

## Not Included (Future Enhancements)

### Phase 6: Advanced Features (Future)
- **Webhook Integration**: Real-time notifications from Radarr/Sonarr
- **Automatic Scheduling**: Cron-like scheduling for scans and downloads
- **Priority Queue**: User-defined download priorities
- **Torrent Support**: Download from torrent sources in addition to direct links
- **Subtitle Download**: Automatic subtitle fetching and matching
- **Quality Upgrades**: Replace existing files with higher quality versions
- **Multi-Language Support**: Handle multiple audio/subtitle tracks
- **Watch Folder**: Auto-import from external download tools
- **Cloud Storage**: Support for S3, Google Drive, etc.
- **Web UI**: Browser-based interface for management

### Nice-to-Have Features
- Email/Slack notifications on download completion
- Download speed graphs and statistics
- Duplicate detection across libraries
- Automatic file repair using par2
- Integration with Plex/Jellyfin for library updates
- Mobile app for monitoring
- Custom post-processing scripts
- Bandwidth scheduling (slow during day, fast at night)

---

## Success Metrics

### Functional Metrics
- [ ] Successfully query Radarr/Sonarr for missing items
- [ ] Match accuracy > 90% for movies
- [ ] Match accuracy > 85% for TV episodes
- [ ] Download success rate > 95%
- [ ] Resume success rate > 90% after interruption

### Performance Metrics
- [ ] Scan 10,000 playlist items in < 30 seconds
- [ ] Match 1,000 items in < 5 seconds
- [ ] Download 3 concurrent files without issues
- [ ] API response times < 200ms (p95)
- [ ] Zero memory leaks during 24h operation

### Quality Metrics
- [ ] Test coverage > 80% for download logic
- [ ] Zero critical security vulnerabilities
- [ ] All error paths tested
- [ ] Documentation complete and accurate
- [ ] CI/CD pipeline passing

---

## Development Notes

### Testing Strategy
- **Unit Tests**: All business logic, matching algorithms, download logic
- **Integration Tests**: API endpoints, database operations, file operations
- **End-to-End Tests**: Complete workflows from scan to download
- **Mock Services**: Mock Radarr/Sonarr responses for testing
- **Test Data**: Sample M3U files with various formats

### Deployment Checklist
- [ ] Environment variables documented
- [ ] Configuration examples provided
- [ ] Database migrations tested
- [ ] API documentation generated
- [ ] CLI help text complete
- [ ] Docker image built and tested
- [ ] Security review completed
- [ ] Performance benchmarks documented

### Monitoring Requirements
- Log all download operations
- Track success/failure rates
- Monitor disk space usage
- Alert on repeated failures
- Track API call rates to Radarr/Sonarr
- Monitor memory and CPU usage

---

## Getting Started

### Prerequisites Before Phase 1
- Complete existing Phase 2 tasks (M3U parser, content detection, bulk import)
- Ensure test coverage > 80% for existing code
- Radarr/Sonarr test instances available
- Sample M3U playlist with diverse content

### First Steps
1. Review and approve this implementation plan
2. Set up Radarr/Sonarr test environments
3. Create test M3U playlists with known movies/episodes
4. Implement Phase 1, Task 1.3 (Configuration Extension)
5. Begin Phase 1, Tasks 1.1 and 1.2 in parallel

### Development Environment Setup
```bash
# Install Radarr (Docker)
docker run -d --name radarr \
  -p 7878:7878 \
  -v radarr_config:/config \
  linuxserver/radarr

# Install Sonarr (Docker)
docker run -d --name sonarr \
  -p 8989:8989 \
  -v sonarr_config:/config \
  linuxserver/sonarr

# Update config.yml with test credentials
cp config.yml.example config.yml
# Edit radarr and sonarr sections
```

---

*This implementation plan follows the structure specified in implementation-planner.prompt.md and focuses on delivering a complete download solution for the Stalkeer project.*
