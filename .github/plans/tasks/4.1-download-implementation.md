# Stalkeer Download Implementation Plan

## Overview

### Problem Statement
Stalkeer needs to download missing media items (movies and TV shows) from M3U playlist direct links after identifying what's missing from Radarr and Sonarr. The system must:
- Query Radarr and Sonarr APIs to identify missing media
- Match missing items with available items in the M3U playlist
- Download media files via direct HTTP/HTTPS links
- Track download progress and status
- Handle errors, retries, and bandwidth management

### Success Criteria
- Successfully integrate with Radarr and Sonarr APIs to identify missing media
- Match missing items with M3U playlist items with high accuracy
- Download media files with progress tracking and resume capability
- Handle concurrent downloads with configurable limits
- Store downloaded files in organized directory structure
- Track all download operations in database
- Provide REST API endpoints to monitor and manage downloads
- Support dry-run mode to preview download actions without executing

### Target Users
- Radarr/Sonarr users who want to automatically fill their media library from M3U playlists
- Users managing large media collections from streaming sources
- Users with bandwidth constraints who need download management

## Technical Approach

### Architecture Components

1. **External Service Integration Layer** (`internal/external/`)
   - Radarr API client: Query missing movies, get movie details
   - Sonarr API client: Query missing episodes, get series details
   - TMDB API client: Enhance matching with metadata (see Task 2.7)

2. **Matching Engine** (`internal/matcher/`)
   - Fuzzy matching algorithm for titles
   - Season/episode number matching for TV shows
   - Quality/resolution matching
   - Confidence scoring system

3. **Download Manager** (`internal/downloader/`)
   - HTTP downloader with resume support
   - Concurrent download pool with limits
   - Progress tracking and callbacks
   - Bandwidth throttling
   - Retry logic with exponential backoff

4. **File Manager** (`internal/filemanager/`)
   - Directory organization (movies vs tvshows)
   - File naming conventions
   - Disk space validation
   - File verification (checksum, size)

### Data Models

**New Models**:
```go
// DownloadTask - Tracks download operations
type DownloadTask struct {
    ID              uint
    PlaylistItemID  uint
    TargetService   string  // "radarr" or "sonarr"
    TargetItemID    string  // Radarr/Sonarr item ID
    FilePath        string
    FileSize        int64
    DownloadedBytes int64
    Status          DownloadStatus
    ErrorMessage    *string
    RetryCount      int
    CreatedAt       time.Time
    StartedAt       *time.Time
    CompletedAt     *time.Time
}

// MatchResult - Stores matching results
type MatchResult struct {
    ID              uint
    PlaylistItemID  uint
    TargetService   string
    TargetItemID    string
    TargetTitle     string
    MatchScore      float64
    IsConfirmed     bool
    CreatedAt       time.Time
}
```

**Extended Configuration**:
```yaml
radarr:
  url: http://localhost:7878
  api_key: your_api_key
  quality_profile_id: 1
  
sonarr:
  url: http://localhost:8989
  api_key: your_api_key
  quality_profile_id: 1

downloads:
  concurrent_limit: 3
  retry_attempts: 3
  retry_delay: 60s
  bandwidth_limit: 10MB  # 0 for unlimited
  timeout: 30m
  verify_downloads: true
  
directories:
  movies: /path/to/movies
  tvshows: /path/to/tvshows
  temp: /path/to/temp
```

### API Endpoints

```
# Missing Items Detection
GET  /api/v1/missing/movies           # List missing movies from Radarr
GET  /api/v1/missing/tvshows          # List missing episodes from Sonarr
POST /api/v1/missing/scan             # Trigger scan for missing items

# Matching
GET  /api/v1/matches                  # List all matches
GET  /api/v1/matches/:id              # Get match details
POST /api/v1/matches/:id/confirm      # Confirm a match
DELETE /api/v1/matches/:id            # Reject a match

# Downloads
GET  /api/v1/downloads                # List all downloads
GET  /api/v1/downloads/:id            # Get download status
POST /api/v1/downloads                # Create download task(s)
PUT  /api/v1/downloads/:id/pause      # Pause download
PUT  /api/v1/downloads/:id/resume     # Resume download
DELETE /api/v1/downloads/:id          # Cancel/delete download
GET  /api/v1/downloads/stats          # Get download statistics

# Settings
GET  /api/v1/settings/radarr          # Get Radarr settings
PUT  /api/v1/settings/radarr          # Update Radarr settings
GET  /api/v1/settings/sonarr          # Get Sonarr settings
PUT  /api/v1/settings/sonarr          # Update Sonarr settings
```

### Technical Decisions

1. **HTTP Client**: Use standard `net/http` with custom transport for bandwidth limiting
2. **Concurrent Downloads**: Use worker pool pattern with `sync.WaitGroup` and channels
3. **Progress Tracking**: Use `io.TeeReader` to track bytes as they're downloaded
4. **Resume Support**: Use HTTP Range headers and append mode for partial downloads
5. **Matching Algorithm**: Levenshtein distance for fuzzy title matching
6. **File Organization**: Follow Radarr/Sonarr naming conventions for compatibility

### Trade-offs

- **Matching Accuracy vs Speed**: Fuzzy matching is slower but more accurate; use caching for repeated lookups
- **Download Speed vs Resource Usage**: Concurrent downloads increase speed but use more memory/bandwidth
- **Storage vs Verification**: File verification adds time but ensures integrity
- **API Polling vs Webhooks**: Polling is simpler but less efficient; implement polling first, webhooks later

## Implementation Plan

### Phase 1: External Service Integration (5-7 days)

**1.1: Radarr API Client** (Medium)
- [ ] Create `internal/external/radarr/` package
- [ ] Implement authentication with API key
- [ ] `GetMissingMovies()` - Fetch movies marked as wanted
- [ ] `GetMovieDetails(id)` - Get detailed movie information
- [ ] `UpdateMovie(id, data)` - Update movie status after download
- [ ] Unit tests with mock HTTP responses
- [ ] Integration tests with test Radarr instance

**Dependencies**: Configuration management (Phase 1, Task 1.2 - Complete)

**1.2: Sonarr API Client** (Medium)
- [ ] Create `internal/external/sonarr/` package
- [ ] Implement authentication with API key
- [ ] `GetMissingSeries()` - Fetch series with missing episodes
- [ ] `GetMissingEpisodes()` - Get list of missing episodes
- [ ] `GetEpisodeDetails(id)` - Get detailed episode information
- [ ] `UpdateEpisode(id, data)` - Update episode status after download
- [ ] Unit tests with mock HTTP responses
- [ ] Integration tests with test Sonarr instance

**Dependencies**: Configuration management (Phase 1, Task 1.2 - Complete)

**1.3: Configuration Extension** (Small)
- [ ] Extend `Config` struct with Radarr/Sonarr settings
- [ ] Add download configuration options
- [ ] Add directory configuration
- [ ] Update `config.yml.example`
- [ ] Add validation for new config fields
- [ ] Unit tests for config loading

**Dependencies**: None (extends existing config)

**1.4: Database Schema for Downloads** (Medium)
- [ ] Create `download_task.go` model
- [ ] Create `match_result.go` model
- [ ] Add download status constants
- [ ] Create database indexes
- [ ] Write migration support
- [ ] Unit tests for models
- [ ] Integration tests with database

**Dependencies**: Database setup (Phase 1, Task 1.3 - Complete)

---

### Phase 2: Matching Engine (4-6 days)

**2.1: Title Matching Algorithm** (Large)
- [ ] Create `internal/matcher/` package
- [ ] Implement fuzzy string matching (Levenshtein distance)
- [ ] Implement title normalization (remove special chars, years, quality tags)
- [ ] `MatchMovie(radarrMovie, playlistItems)` - Find best matches
- [ ] `MatchEpisode(sonarrEpisode, playlistItems)` - Match TV episodes
- [ ] Confidence scoring system (0.0-1.0)
- [ ] Configurable match threshold (default: 0.8)
- [ ] Comprehensive unit tests with edge cases
- [ ] Benchmark tests for performance

**Dependencies**: External service clients (2.1, 2.2), TMDB integration (Task 2.7)

**2.2: Season/Episode Parser Enhancement** (Medium)
- [ ] Extend M3U parser to extract season/episode with more patterns
- [ ] Support formats: S01E01, 1x01, Season 1 Episode 1, etc.
- [ ] Extract year from titles for movies
- [ ] Extract quality/resolution indicators
- [ ] Unit tests with various title formats

**Dependencies**: M3U parser (Phase 2, Task 2.1 - Complete)

**2.3: Match Storage and API** (Medium)
- [ ] Implement match persistence in database
- [ ] Create REST endpoints for match management
- [ ] Manual match confirmation workflow
- [ ] Auto-confirmation for high-confidence matches (>0.95)
- [ ] Unit tests for match logic
- [ ] Integration tests for API endpoints

**Dependencies**: Database schema (1.4), Title matching (2.1)

---

### Phase 3: Download Manager (6-8 days)

**3.1: HTTP Downloader Core** (Large)
- [ ] Create `internal/downloader/` package
- [ ] Implement HTTP client with timeout configuration
- [ ] Resume support using HTTP Range headers
- [ ] Progress tracking with callbacks
- [ ] File integrity verification (size, optional checksum)
- [ ] Cleanup on failure
- [ ] Unit tests with mock HTTP server
- [ ] Integration tests with test files

**Dependencies**: Configuration (1.3)

**3.2: Download Task Manager** (Large)
- [ ] Task queue implementation using channels
- [ ] Worker pool for concurrent downloads
- [ ] Task status management (queued, downloading, paused, completed, failed)
- [ ] Retry logic with exponential backoff
- [ ] Bandwidth throttling using rate limiter
- [ ] Graceful shutdown handling
- [ ] Unit tests for task management
- [ ] Stress tests with multiple concurrent downloads

**Dependencies**: HTTP downloader (3.1), Database schema (1.4)

**3.3: File Manager** (Medium)
- [ ] Create `internal/filemanager/` package
- [ ] Directory structure creation (movies/, tvshows/)
- [ ] File naming conventions matching Radarr/Sonarr
- [ ] Disk space validation before download
- [ ] Temporary file handling
- [ ] File move/rename after completion
- [ ] Unit tests for file operations
- [ ] Integration tests with actual file system

**Dependencies**: None

**3.4: Download API Endpoints** (Medium)
- [ ] Implement download REST API handlers
- [ ] Create download task(s) endpoint with validation
- [ ] Pause/resume/cancel endpoints
- [ ] Download statistics endpoint
- [ ] Real-time progress updates (consider WebSocket)
- [ ] Unit tests for handlers
- [ ] Integration tests with full stack

**Dependencies**: Task manager (3.2), File manager (3.3)

---

### Phase 4: Integration & Workflow (4-5 days)

**4.1: Missing Items Scanner** (Medium)
- [ ] CLI command: `stalkeer scan missing`
- [ ] Query Radarr for missing movies
- [ ] Query Sonarr for missing episodes
- [ ] Run matching algorithm
- [ ] Store matches in database
- [ ] Generate scan report
- [ ] Dry-run mode for scanning
- [ ] Unit tests for scan logic
- [ ] Integration tests with test data

**Dependencies**: External clients (1.1, 1.2), Matcher (2.1)

**4.2: Download Workflow** (Medium)
- [ ] CLI command: `stalkeer download start`
- [ ] Load confirmed matches from database
- [ ] Create download tasks for matches
- [ ] Start download manager
- [ ] Monitor download progress
- [ ] Handle completion (notify Radarr/Sonarr)
- [ ] Error handling and reporting
- [ ] Dry-run mode for downloads
- [ ] Integration tests for full workflow

**Dependencies**: Scanner (4.1), Download manager (3.2)

**4.3: Status and Monitoring** (Small)
- [ ] CLI command: `stalkeer download status`
- [ ] Display active downloads with progress
- [ ] Show download statistics
- [ ] List recent completed/failed downloads
- [ ] Export status to JSON
- [ ] Unit tests for status display

**Dependencies**: Download manager (3.2)

**4.4: Cleanup and Maintenance** (Small)
- [ ] CLI command: `stalkeer cleanup`
- [ ] Remove old completed tasks from database
- [ ] Clean temporary files
- [ ] Archive processing logs
- [ ] Configurable retention policy
- [ ] Unit tests for cleanup logic

**Dependencies**: Database models (1.4)

---

### Phase 5: Polish & Production Ready (3-4 days)

**5.1: Error Handling & Recovery** (Medium)
- [ ] Comprehensive error handling throughout download flow
- [ ] Transaction rollback on failures
- [ ] Disk full handling
- [ ] Network error recovery
- [ ] Corrupted file detection
- [ ] Detailed error logging
- [ ] Error notification system
- [ ] Unit tests for error scenarios

**Dependencies**: All previous phases

**5.2: Performance Optimization** (Small)
- [ ] Database query optimization
- [ ] Connection pooling tuning
- [ ] Memory usage profiling
- [ ] Concurrent download optimization
- [ ] Cache frequently accessed data
- [ ] Benchmark tests
- [ ] Performance documentation

**Dependencies**: All previous phases

**5.3: Documentation** (Small)
- [ ] Update README with download features
- [ ] API documentation for new endpoints
- [ ] Configuration guide for Radarr/Sonarr
- [ ] Troubleshooting guide
- [ ] Example workflows and use cases
- [ ] CLI command reference
- [ ] Architecture diagram

**Dependencies**: All previous phases

**5.4: Security & Validation** (Medium)
- [ ] API key validation and secure storage
- [ ] Path traversal prevention in file operations
- [ ] Input validation for all API endpoints
- [ ] Rate limiting for API calls
- [ ] HTTPS enforcement option
- [ ] Security audit
- [ ] Penetration testing

**Dependencies**: All previous phases

**5.5: Integration Testing Suite** (Medium)
- [ ] End-to-end test: scan → match → download workflow
- [ ] Test with real Radarr/Sonarr instances
- [ ] Test with various M3U formats
- [ ] Test error scenarios (network failures, disk full, etc.)
- [ ] Test concurrent operations
- [ ] Load testing with multiple downloads
- [ ] CI/CD integration

**Dependencies**: All previous phases

---

## Task Summary by Complexity

### Small Tasks (1-2 days each)
- 1.3: Configuration Extension
- 4.3: Status and Monitoring
- 4.4: Cleanup and Maintenance
- 5.2: Performance Optimization
- 5.3: Documentation

### Medium Tasks (2-3 days each)
- 1.1: Radarr API Client
- 1.2: Sonarr API Client
- 1.4: Database Schema for Downloads
- 2.2: Season/Episode Parser Enhancement
- 2.3: Match Storage and API
- 3.3: File Manager
- 3.4: Download API Endpoints
- 4.1: Missing Items Scanner
- 4.2: Download Workflow
- 5.1: Error Handling & Recovery
- 5.4: Security & Validation
- 5.5: Integration Testing Suite

### Large Tasks (3-5 days each)
- 2.1: Title Matching Algorithm
- 3.1: HTTP Downloader Core
- 3.2: Download Task Manager

**Total Estimated Timeline**: 22-30 days (approximately 4-6 weeks)

---

## Considerations

### Assumptions

- Radarr and Sonarr APIs are stable and accessible
- M3U playlist items have direct HTTP/HTTPS download URLs
- Users have sufficient disk space for downloads
- Network connectivity is generally reliable
- Users have valid API keys for Radarr/Sonarr
- Downloaded files can be moved/renamed after completion

### Constraints

- **Time**: 4-6 weeks for full implementation
- **Technical**: 
  - Go standard library for most functionality
  - Existing GORM database structure
  - RESTful API design patterns
  - CLI must remain responsive during downloads
- **Resource**: 
  - Memory usage scales with concurrent downloads
  - Disk space required for temporary files
  - Network bandwidth shared among concurrent downloads

### Risks & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Radarr/Sonarr API changes | High | Low | Version API calls, implement fallbacks |
| Low match accuracy | High | Medium | Manual confirmation workflow, tunable thresholds |
| Download failures | Medium | High | Retry logic, resume support, error logging |
| Disk space exhaustion | High | Medium | Pre-download validation, configurable limits |
| Network interruptions | Medium | High | Resume support, automatic retry |
| Concurrent download crashes | High | Low | Worker pool limits, graceful error handling |
| Security vulnerabilities | High | Low | Input validation, security audit, HTTPS |

### Performance Targets

- Match 1000 items in < 5 seconds
- Download 3 concurrent streams without degradation
- Resume interrupted download within 10 seconds
- API response time < 200ms for status queries
- Support M3U playlists with 50,000+ items

---

## Not Included (Future Enhancements)

### Phase 6: Advanced Features (Future)
- **Webhook Integration**: Real-time notifications from Radarr/Sonarr
- **Automatic Scheduling**: Cron-like scheduling for scans and downloads
- **Priority Queue**: User-defined download priorities
- **Torrent Support**: Download from torrent sources in addition to direct links
- **Subtitle Download**: Automatic subtitle fetching and matching
- **Quality Upgrades**: Replace existing files with higher quality versions
- **Multi-Language Support**: Handle multiple audio/subtitle tracks
- **Watch Folder**: Auto-import from external download tools
- **Cloud Storage**: Support for S3, Google Drive, etc.
- **Web UI**: Browser-based interface for management

### Nice-to-Have Features
- Email/Slack notifications on download completion
- Download speed graphs and statistics
- Duplicate detection across libraries
- Automatic file repair using par2
- Integration with Plex/Jellyfin for library updates
- Mobile app for monitoring
- Custom post-processing scripts
- Bandwidth scheduling (slow during day, fast at night)

---

## Success Metrics

### Functional Metrics
- [ ] Successfully query Radarr/Sonarr for missing items
- [ ] Match accuracy > 90% for movies
- [ ] Match accuracy > 85% for TV episodes
- [ ] Download success rate > 95%
- [ ] Resume success rate > 90% after interruption

### Performance Metrics
- [ ] Scan 10,000 playlist items in < 30 seconds
- [ ] Match 1,000 items in < 5 seconds
- [ ] Download 3 concurrent files without issues
- [ ] API response times < 200ms (p95)
- [ ] Zero memory leaks during 24h operation

### Quality Metrics
- [ ] Test coverage > 80% for download logic
- [ ] Zero critical security vulnerabilities
- [ ] All error paths tested
- [ ] Documentation complete and accurate
- [ ] CI/CD pipeline passing

---

## Development Notes

### Testing Strategy
- **Unit Tests**: All business logic, matching algorithms, download logic
- **Integration Tests**: API endpoints, database operations, file operations
- **End-to-End Tests**: Complete workflows from scan to download
- **Mock Services**: Mock Radarr/Sonarr responses for testing
- **Test Data**: Sample M3U files with various formats

### Deployment Checklist
- [ ] Environment variables documented
- [ ] Configuration examples provided
- [ ] Database migrations tested
- [ ] API documentation generated
- [ ] CLI help text complete
- [ ] Docker image built and tested
- [ ] Security review completed
- [ ] Performance benchmarks documented

### Monitoring Requirements
- Log all download operations
- Track success/failure rates
- Monitor disk space usage
- Alert on repeated failures
- Track API call rates to Radarr/Sonarr
- Monitor memory and CPU usage

---

## Getting Started

### Prerequisites Before Phase 1
- Complete existing Phase 2 tasks (M3U parser, content detection, bulk import)
- Ensure test coverage > 80% for existing code
- Radarr/Sonarr test instances available
- Sample M3U playlist with diverse content

### First Steps
1. Review and approve this implementation plan
2. Set up Radarr/Sonarr test environments
3. Create test M3U playlists with known movies/episodes
4. Implement Phase 1, Task 1.3 (Configuration Extension)
5. Begin Phase 1, Tasks 1.1 and 1.2 in parallel

### Development Environment Setup
```bash
# Install Radarr (Docker)
docker run -d --name radarr \
  -p 7878:7878 \
  -v radarr_config:/config \
  linuxserver/radarr

# Install Sonarr (Docker)
docker run -d --name sonarr \
  -p 8989:8989 \
  -v sonarr_config:/config \
  linuxserver/sonarr

# Update config.yml with test credentials
cp config.yml.example config.yml
# Edit radarr and sonarr sections
```

---

*This implementation plan follows the structure specified in implementation-planner.prompt.md and focuses on delivering a complete download solution for the Stalkeer project.*
