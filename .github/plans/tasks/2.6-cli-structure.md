# Task 2.6: CLI Structure (Cobra)

**Phase**: 2 (Core Functionality)  
**Complexity**: Medium  
**Status**: Completed

## Description

Build comprehensive command hierarchy using Cobra framework for operational tasks and administration.

## Details

- Create CLI package at `/internal/cli/` or `/cmd/`
- Implement command hierarchy:

  **Root command:**
  - `stalkeer` - Application entry point
  - Global flags: `--config`, `--log-level`, `--db-url`
  - Subcommands: process, server, dryrun, config, migrate

  **Subcommands:**
  - `stalkeer process` - Load M3U and store to database
    - Flags: `--file` (M3U path), `--force` (re-process), `--limit` (max items)
    - Output: processing summary and statistics
  
  - `stalkeer server` - Start REST API server
    - Flags: `--port` (default: 8080), `--address` (default: 0.0.0.0)
    - Output: startup messages, health status
  
  - `stalkeer dryrun` - Execute dry-run analysis
    - Flags: `--file` (M3U path), `--limit` (max items to analyze)
    - Output: structured analysis report
  
  - `stalkeer config` - Validate and display current configuration
    - Flags: `--show-secrets` (reveal password fields)
    - Output: formatted config display
  
  - `stalkeer migrate` - Database schema setup/migration
    - Flags: `--up` (apply migrations), `--down` (rollback)
    - Output: migration status

  - `stalkeer version` - Display application version
    - Output: version number and build info

  - `stalkeer radarr` - Download missing movies from Radarr
    - Flags: `--dry-run`, `--limit`, `--parallel`, `--force`, `--verbose`
    - Output: download progress and statistics
  
  - `stalkeer sonarr` - Download missing TV episodes from Sonarr
    - Flags: `--dry-run`, `--limit`, `--parallel`, `--force`, `--verbose`, `--series-id`
    - Output: download progress and statistics

- Flag implementation:
  - Global flags available to all commands
  - Command-specific flags
  - Flag validation and type checking
  - Short/long flag variants where appropriate

- Help and documentation:
  - Clear help text for all commands
  - Usage examples for common workflows
  - Comprehensive --help output
  - Man page generation support

- Error handling:
  - Clear error messages on command failure
  - Exit codes: 0 (success), 1 (error), 2 (usage error)
  - Helpful suggestions for common mistakes

- Unit tests:
  - Test command parsing
  - Test flag handling
  - Test help text generation
  - Test error cases

## Dependencies

- Task 2.1 (M3U Parser)
- Task 2.4 (REST API)
- Task 2.5 (Dry-Run Mode)

## Acceptance Criteria

- [x] All commands parse and execute correctly
- [x] Global flags properly propagate to subcommands
- [x] Help text comprehensive and accurate
- [x] Command examples documented and tested
- [x] Exit codes appropriate for success/failure
- [ ] Unit tests verify command parsing
- [ ] Flags and options thoroughly tested

## Completion Notes

- Complete Cobra CLI structure in `/cmd/main.go`
- Root command with global `--config` flag
- All 9 subcommands implemented:
  - `version`: Displays version number
  - `server`: Start REST API server with configurable port and address
  - `process`: Process M3U and store to database with full processing pipeline
  - `dryrun`: Execute dry-run analysis with configurable limit
  - `config`: Display configuration with --show-secrets flag
  - `migrate`: Run database migrations
  - `radarr`: Download missing movies from Radarr (added Jan 2026)
  - `sonarr`: Download missing TV episodes from Sonarr (added Jan 2026)
- Command-specific flags:
  - `server`: `-p, --port`, `-a, --address`
  - `process`: `--force`, `--limit`, `--batch-size`, `--progress`, `--skip-tmdb`, `--tmdb-language`
  - `dryrun`: `--limit`
  - `config`: `--show-secrets`
  - `radarr`: `--dry-run`, `--limit`, `--parallel`, `--force`, `-v/--verbose`
  - `sonarr`: `--dry-run`, `--limit`, `--parallel`, `--force`, `-v/--verbose`, `--series-id`
- Configuration initialization with cobra.OnInitialize
- Proper error handling and exit codes throughout
- Comprehensive help text for all commands
- File path support via CLI arguments or config file
- Integration with external services (Radarr/Sonarr)
- Download management with progress tracking

**Recent Updates (Jan 2026):**
- Added `radarr` command for downloading missing movies
- Added `sonarr` command for downloading missing TV episodes
- Integrated downloader service with retry logic
- Implemented TMDB-based matching for content correlation
- Added download state tracking in database
- Support for dry-run mode in download commands

**Future Enhancements:**
- Add unit tests for command parsing logic
- Add progress bars for long-running operations (using libraries like cheggaaa/pb)
- Add interactive mode for configuration setup
- Implement parallel download support (flag exists but not fully utilized)
- Add resume capability for interrupted downloads
