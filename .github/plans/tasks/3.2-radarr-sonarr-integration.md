# Task 3.2: Radarr/Sonarr Integration

**Phase**: 3 (Polish, Integration & Deploy)  
**Complexity**: Large  
**Status**: Not Started

## Description

Integrate with Radarr and Sonarr APIs to identify missing movies and TV shows in the M3U playlist.

## Details

- Create integration package at `/internal/integration/radarr_sonarr.go`
- Implement Radarr client:
  - HTTP client with timeout and retry configuration
  - Fetch monitored movies endpoint: `GET /api/v3/movie`
  - Parse response: movie ID, TMDB ID, title, year
  - Cache results with TTL (6 hours)
  - Error handling for connection failures

- Implement Sonarr client:
  - HTTP client with timeout and retry configuration
  - Fetch monitored series endpoint: `GET /api/v3/series`
  - Parse response: series ID, TVDB ID, title
  - Cache results with TTL (6 hours)
  - Error handling for connection failures

- Implement matching logic:
  - Primary match: TMDB ID comparison
  - Fallback match: title+year fuzzy matching for movies
  - Fallback match: title fuzzy matching for series
  - Return match confidence (0-100)

- Identify missing content:
  - Compare M3U items against Radarr collection
  - Compare M3U items against Sonarr collection
  - Return items in M3U but not in collections
  - Categorize by content type

- REST API endpoints:
  - `GET /api/v1/missing-content` - List items not in Radarr/Sonarr
    - Query params: `type` (movie|series), `limit`, `offset`
    - Response: array of missing items with match confidence
  
  - `GET /api/v1/radarr-sync` - Trigger Radarr sync
    - Response: sync result with counts
  
  - `GET /api/v1/sonarr-sync` - Trigger Sonarr sync
    - Response: sync result with counts
  
  - `GET /api/v1/sync-status` - Get last sync status
    - Response: timestamp, item counts, sync health

- Caching strategy:
  - Cache external API responses (TTL: 6 hours)
  - Invalidate cache on manual sync trigger
  - Monitor cache hits/misses

- Unit tests:
  - Mock Radarr/Sonarr API responses
  - Test matching logic with various title formats
  - Test error handling for API failures
  - Test cache invalidation
  - Test missing content identification

## Dependencies

- Task 2.4 (REST API scaffolding)
- Task 1.3 (Database schema)

## Acceptance Criteria

- [ ] Radarr client connects and fetches movies successfully
- [ ] Sonarr client connects and fetches series successfully
- [ ] Missing items correctly identified
- [ ] Matching algorithm achieves 95%+ accuracy on test data
- [ ] Cache properly stores and invalidates results
- [ ] All API endpoints functional and documented
- [ ] Error handling for connection failures
- [ ] Unit tests cover matching scenarios and edge cases
