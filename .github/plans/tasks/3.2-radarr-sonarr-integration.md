# Task 3.2: Radarr/Sonarr Integration

**Phase**: 3 (Polish, Integration & Deploy)  
**Complexity**: Large  
**Status**: Completed

## Description

Integrate with Radarr and Sonarr APIs to identify missing movies and TV shows, enabling download of missing content from the M3U playlist.

## Completion Notes

**Completed Components:**
- ✅ Radarr client implementation in `/internal/external/radarr/radarr.go`
  - HTTP client with timeout and retry configuration
  - `GetMissingMovies()` fetches movies marked as wanted
  - `GetMovieDetails()` retrieves detailed movie information
  - TVDB ID included in movie metadata for cross-platform matching
  - Authentication with API key
  - Comprehensive error handling
  
- ✅ Sonarr client implementation in `/internal/external/sonarr/sonarr.go`
  - HTTP client with timeout and retry configuration
  - `GetMissingSeries()` fetches series with missing episodes
  - `GetMissingEpisodes()` retrieves list of missing episodes
  - `GetEpisodeDetails()` for detailed episode information
  - TVDB ID included for series/episode matching
  - Authentication with API key
  - Comprehensive error handling

- ✅ Configuration in `config.yml`:
  ```yaml
  radarr:
    base_url: "http://localhost:7878"
    api_key: "your_api_key"
  sonarr:
    base_url: "http://localhost:8989"
    api_key: "your_api_key"
  ```

- ✅ Matcher service in `/internal/matcher/matcher.go`:
  - TMDB ID-based matching for movies
  - TVDB ID-based matching for TV shows (when available)
  - Fuzzy title matching with Levenshtein distance
  - Year matching for movies
  - Season/episode matching for TV shows
  - Confidence scoring (0.0-1.0)
  - Title normalization (removes special chars, quality tags)

- ✅ Unit tests:
  - `radarr_test.go` with mock HTTP responses
  - `sonarr_test.go` with mock HTTP responses
  - `matcher_test.go` with various title formats

## Details

- Create integration package at `/internal/integration/radarr_sonarr.go`
- Implement Radarr client:
  - HTTP client with timeout and retry configuration
  - Fetch monitored movies endpoint: `GET /api/v3/movie`
  - Parse response: movie ID, TMDB ID, title, year
  - Cache results with TTL (6 hours)
  - Error handling for connection failures

- Implement Sonarr client:
  - HTTP client with timeout and retry configuration
  - Fetch monitored series endpoint: `GET /api/v3/series`
  - Parse response: series ID, TVDB ID, title
  - Cache results with TTL (6 hours)
  - Error handling for connection failures

- Implement matching logic:
  - Primary match: TMDB ID comparison
  - Fallback match: title+year fuzzy matching for movies
  - Fallback match: title fuzzy matching for series
  - Return match confidence (0-100)

- Identify missing content:
  - Compare M3U items against Radarr collection
  - Compare M3U items against Sonarr collection
  - Return items in M3U but not in collections
  - Categorize by content type

- REST API endpoints:
  - `GET /api/v1/missing-content` - List items not in Radarr/Sonarr
    - Query params: `type` (movie|series), `limit`, `offset`
    - Response: array of missing items with match confidence
  
  - `GET /api/v1/radarr-sync` - Trigger Radarr sync
    - Response: sync result with counts
  
  - `GET /api/v1/sonarr-sync` - Trigger Sonarr sync
    - Response: sync result with counts
  
  - `GET /api/v1/sync-status` - Get last sync status
    - Response: timestamp, item counts, sync health

- Caching strategy:
  - Cache external API responses (TTL: 6 hours)
  - Invalidate cache on manual sync trigger
  - Monitor cache hits/misses

- Unit tests:
  - Mock Radarr/Sonarr API responses
  - Test matching logic with various title formats
  - Test error handling for API failures
  - Test cache invalidation
  - Test missing content identification

## Dependencies

- Task 2.4 (REST API scaffolding)
- Task 1.3 (Database schema)

## Acceptance Criteria

- [x] Radarr client connects and fetches movies successfully
- [x] Sonarr client connects and fetches series successfully
- [x] TMDB ID and TVDB ID matching implemented
- [x] Matching algorithm achieves high accuracy with fuzzy matching fallback
- [x] Error handling for connection failures
- [x] Unit tests cover API clients and matching scenarios
- [x] Configuration properly loaded from config.yml
- [ ] REST API endpoints for missing content query
- [ ] Cache implementation for API responses
- [ ] Integration tests with real Radarr/Sonarr instances
