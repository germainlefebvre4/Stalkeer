# Task 3.3: Radarr/Sonarr Download CLI Commands

**Phase**: 3 (Polish, Integration & Deploy)  
**Complexity**: Large  
**Status**: In Progress

## Overview

Build CLI commands to fetch missing content from Radarr and Sonarr, match against the local database (movies/tvshows tables) using TMDB metadata, and trigger downloads of matched stream URLs. This provides an automated workflow to download missing media directly from the M3U playlist sources.

### Success Criteria
- Missing movies/TV shows identified from Radarr/Sonarr
- Accurate matching against local database using TMDB IDs
- Stream URLs downloaded to configured directories
- Comprehensive error handling and progress reporting
- Dry-run mode for preview before actual downloads

### Who Will Use This
System administrators and media library managers who want to automatically fill gaps in their Radarr/Sonarr collections using content from M3U playlists.

## Technical Approach

### High-Level Architecture

1. **CLI Commands**: `stalkeer radarr` and `stalkeer sonarr`
   - Fetch missing content from respective APIs
   - Match against local database using TMDB metadata
   - Trigger downloads for matched items
   - Report statistics and errors

2. **Download Service**: `/internal/downloader/`
   - Handle HTTP/HTTPS stream downloads
   - Progress tracking and resumable downloads
   - Parallel download support with configurable concurrency
   - Integration with ProcessedLine state tracking

3. **Matcher Service**: Extension of `/internal/matcher/`
   - TMDB-based matching for movies (TMDB ID + title/year)
   - TMDB-based matching for TV shows (TMDB ID + season/episode)
   - Confidence scoring for fallback matches
   - Duplicate detection

### Key Technology Choices

- **Radarr/Sonarr Clients**: Existing `/internal/external/radarr` and `/internal/external/sonarr`
- **Database Models**: `Movie` and `TVShow` in `/internal/models/`
- **Download Protocol**: HTTP/HTTPS with retry logic
- **State Management**: `ProcessedLine.State` field (downloading, downloaded, failed)

### Major Technical Decisions

- **TMDB as Primary Match Key**: Use TMDB ID for accurate matching, with fallback to title/year fuzzy matching
- **Sequential vs Parallel Downloads**: Support configurable concurrency (default: 3 parallel downloads)
- **Download Destination**: Radarr/Sonarr-compatible directory structure:
  - Movies: `downloads/movies/Movie Title (Year)/Movie Title (Year).<extension>`
  - TV Shows: `downloads/tvshows/Series Title/Season ##/Series Title - S##E## - Episode Title.<extension>`
- **Path Alignment**: Directory structure matches Radarr/Sonarr conventions for seamless integration and potential auto-import
- **Idempotency**: Track download state in database to avoid re-downloading existing content

## Implementation Plan

### Phase 1: Foundation (Day 1-2)

**Task 1.1: Extend Matcher Service** (Medium)
- Add `MatchMovieByTMDB(tmdbID int, title string, year int)` function
- Add `MatchTVShowByTMDB(tmdbID int, title string, season, episode int)` function
- Return match confidence score (0-100)
- Unit tests for various matching scenarios

**Task 1.2: Create Downloader Service** (Large)
- Create `/internal/downloader/downloader.go`
- HTTP client with timeout, retry, and resume support
- Download to temporary file, then atomic rename
- Progress callback for CLI reporting
- Update `ProcessedLine.State` during download lifecycle
- Unit tests with mock HTTP server

**Task 1.3: Database Query Functions** (Small)
- Add `GetMovieByTMDBID(tmdbID int)` query
- Add `GetTVShowByTMDBID(tmdbID int, season, episode int)` query
- Add `GetProcessedLineByContentID()` to retrieve stream URL
- Unit tests with test database

### Phase 2: Core CLI Implementation (Day 3-4)

**Task 2.1: Radarr Command** (Large)
- Create `radarrCmd` in `/cmd/main.go`
- Flags:
  - `--dry-run`: Preview matches without downloading
  - `--limit N`: Process only N missing movies
  - `--parallel N`: Number of concurrent downloads (default: 3)
  - `--force`: Re-download existing files
- Workflow:
  1. Fetch missing movies from Radarr API
  2. Match each against local `movies` table by TMDB ID
  3. Retrieve stream URL from `processed_lines`
  4. Download to Radarr-compatible path: `downloads/movies/Movie Title (Year)/Movie Title (Year).<extension>`
  5. Update download state in database
- Statistics output: matched, not found, downloaded, failed
- Integration tests

**Task 2.2: Sonarr Command** (Large)
- Create `sonarrCmd` in `/cmd/main.go`
- Flags:
  - `--dry-run`: Preview matches without downloading
  - `--limit N`: Process only N missing episodes
  - `--parallel N`: Number of concurrent downloads (default: 3)
  - `--force`: Re-download existing files
  - `--series-id`: Filter to specific Sonarr series ID
- Workflow:
  1. Fetch missing episodes from Sonarr API
  2. Match each against local `tvshows` table by TMDB ID + season/episode
  3. Retrieve stream URL from `processed_lines`
  4. Download to Sonarr-compatible path: `downloads/tvshows/Series Title/Season ##/Series Title - S##E## - Episode Title.<extension>`
  5. Update download state in database
- Statistics output: matched, not found, downloaded, failed
- Integration tests

**Task 2.3: Progress Reporting** (Medium)
- Live progress bar for downloads (using library like `cheggaaa/pb`)
- Summary table at completion
- Error log file for troubleshooting
- Verbose mode with detailed logging

### Phase 3: Polish & Testing (Day 5)

**Task 3.1: Error Handling** (Medium)
- Network failures with retry
- Disk space checks before download
- Graceful handling of Radarr/Sonarr API errors
- Database transaction rollback on failures
- User-friendly error messages

**Task 3.2: Configuration** (Small)
- Add to `config.yml`:
  - `radarr.base_url`, `radarr.api_key`
  - `sonarr.base_url`, `sonarr.api_key`
  - `downloads.movies_path`, `downloads.tvshows_path`
  - `downloads.max_parallel`, `downloads.timeout`
- Validation on startup

**Task 3.3: Comprehensive Testing** (Large)
- Unit tests for matcher extensions
- Unit tests for downloader service
- Integration tests for full workflows
- Mock Radarr/Sonarr API responses
- Test edge cases: no matches, partial matches, download failures
- Test idempotency (re-running commands)

**Task 3.4: Documentation** (Small)
- Update README with command examples
- Add configuration guide
- Document matching algorithm
- Troubleshooting guide

## Considerations

### Assumptions
- Radarr/Sonarr APIs are accessible and responsive
- M3U playlist content has been processed and stored in database
- TMDB metadata is accurate and complete
- Sufficient disk space for downloads
- Stream URLs are direct download links (not m3u8 playlists)
- Download directories are writable by the application
- Radarr/Sonarr can access download directories for manual import (if post-processing enabled)

### Constraints
- Download speed limited by network bandwidth
- Radarr/Sonarr API rate limits may apply
- Database performance with large catalogs
- File system path length limits on Windows

### Risks and Mitigation

| Risk | Impact | Mitigation |
|------|--------|-----------|
| TMDB ID mismatch between Radarr and database | High | Implement fallback title/year matching |
| Stream URLs become invalid | Medium | Track failures, provide manual retry mechanism |
| Download interruptions | Medium | Implement resume capability |
| Disk space exhaustion | High | Pre-check available space before download |
| Concurrent download overload | Medium | Configurable concurrency limit |
| Database deadlocks | Medium | Proper transaction management and retries |

## Dependencies

- Task 3.2 (Radarr/Sonarr Integration) - for API clients
- Task 2.7 (TMDB Integration) - for metadata matching
- Task 1.3 (Database Schema) - for models and queries

## Acceptance Criteria

### Must Have
- [ ] `stalkeer radarr` command fetches missing movies and downloads matches
- [ ] `stalkeer sonarr` command fetches missing episodes and downloads matches
- [ ] TMDB-based matching achieves 95%+ accuracy
- [ ] Dry-run mode accurately previews actions
- [ ] Downloads tracked with state in `processed_lines` table
- [ ] Progress reporting during downloads
- [ ] Configurable via `config.yml`
- [ ] Error handling covers network, disk, and API failures
- [ ] Unit tests for matcher and downloader
- [ ] Integration tests for full workflows

### Nice to Have
- [ ] Resume interrupted downloads
- [ ] Post-download verification (file size, integrity)
- [ ] Notification system (webhook, email) on completion
- [ ] Bandwidth throttling
- [ ] Schedule periodic sync (cron-like)
- [ ] Web UI for monitoring download queue

## Not Included

- Support for m3u8/HLS stream downloads (requires ffmpeg)
- Automatic organization to Radarr/Sonarr media folders
- Subtitle/metadata downloading
- Quality/resolution filtering
- Duplicate media detection across different sources
- Post-processing scripts

## Implementation Details

### Database Schema Changes

No schema changes required. Utilize existing fields:
- `ProcessedLine.State`: Update to `downloading`, `downloaded`, `failed`
- `ProcessedLine.MovieID` / `TVShowID`: Link to content
- `DownloadInfo`: Optional future enhancement for detailed tracking

### Directory Structure Alignment

Download paths follow Radarr/Sonarr conventions for compatibility:

**Radarr (Movies):**
- Base path: `downloads/movies/`
- Structure: `{MovieTitle} ({Year})/{MovieTitle} ({Year}).{{Extension}}`
- Example: `downloads/movies/The Matrix (1999)/The Matrix (1999).mkv`
- Benefits: Ready for Radarr's "Manual Import" or automatic import with proper configuration

**Sonarr (TV Shows):**
- Base path: `downloads/tvshows/`
- Structure: `{SeriesTitle}/Season {##}/{SeriesTitle} - S{##}E{##} - {EpisodeTitle}.{{Extension}}`
- Example: `downloads/tvshows/Breaking Bad/Season 01/Breaking Bad - S01E01 - Pilot.mkv`
- Benefits: Matches Sonarr's expected format, enables automatic import when configured

**Path Sanitization:**
- Remove invalid filesystem characters: `/ \ : * ? " < > |`
- Replace with underscores or remove entirely
- Ensure compatibility across Windows, Linux, and macOS

### API Design

#### Matcher API
```go
// MatchMovieByTMDB finds a movie in database by TMDB ID
// Returns (movie, confidence, error)
func MatchMovieByTMDB(db *gorm.DB, tmdbID int, title string, year int) (*models.Movie, int, error)

// MatchTVShowByTMDB finds a TV show episode in database by TMDB ID
func MatchTVShowByTMDB(db *gorm.DB, tmdbID int, season, episode int) (*models.TVShow, int, error)
```

#### Downloader API
```go
type DownloadOptions struct {
    URL             string
    DestinationPath string
    ProcessedLineID uint
    OnProgress      func(downloaded, total int64)
}

func Download(ctx context.Context, opts DownloadOptions) error
```

### CLI Command Examples

```bash
# Dry-run to preview Radarr matches
stalkeer radarr --dry-run

# Download up to 10 missing movies from Radarr
stalkeer radarr --limit 10

# Download with 5 parallel downloads
stalkeer radarr --parallel 5

# Force re-download existing files
stalkeer radarr --force

# Sonarr dry-run
stalkeer sonarr --dry-run

# Download missing episodes for specific series
stalkeer sonarr --series-id 42 --limit 20

# Verbose output
stalkeer radarr --verbose
```

### Configuration Example

```yaml
radarr:
  base_url: "http://localhost:7878"
  api_key: "your-radarr-api-key"
  
sonarr:
  base_url: "http://localhost:8989"
  api_key: "your-sonarr-api-key"

downloads:
  movies_path: "./data/downloads/movies"      # Base path for Radarr-compatible movie structure
  tvshows_path: "./data/downloads/tvshows"    # Base path for Sonarr-compatible TV show structure
  max_parallel: 3                              # Number of concurrent downloads
  timeout: 300                                 # seconds
  retry_attempts: 3                            # Number of retry attempts on failure
  # Note: Files are organized as:
  # - Movies: {movies_path}/{Movie Title (Year)}/{Movie Title (Year)}.{{Extension}}
  # - TV Shows: {tvshows_path}/{Series Title}/Season {##}/{Series - S##E## - Episode}.{{Extension}}
```

## Future Enhancements

- **Post-processing**: Automatically import downloaded files to Radarr/Sonarr using their API
  - Trigger Radarr/Sonarr "Manual Import" after download completion
  - Monitor import status and update database accordingly
- **Direct-to-Radarr/Sonarr paths**: Option to download directly to Radarr/Sonarr media folders
  - Requires proper permissions and path configuration
  - Enables immediate availability in media servers
- **Quality selection**: Prefer 1080p over 720p when multiple matches exist
- **Smart scheduling**: Download during off-peak hours
- **Cloud storage**: Upload directly to S3, Google Drive, etc.
- **Content verification**: Check against file hash or sample playback
- **Metadata sidecar files**: Generate .nfo files for enhanced media server compatibility

## Implementation Progress

### Completed
- [x] Created comprehensive task plan with phases and acceptance criteria
- [x] Implemented downloader service (`/internal/downloader/downloader.go`)
  - HTTP download with retry logic
  - Progress tracking with callbacks
  - Atomic file writes (temp file + rename)
  - ProcessedLine state management
- [x] Extended matcher service with TMDB-based matching
  - `MatchMovieByTMDB()` - Primary TMDB ID match + fallback fuzzy matching
  - `MatchTVShowByTMDB()` - TMDB ID + season/episode match + fuzzy fallback
  - Confidence scoring for matches
- [x] Added downloads configuration
  - `DownloadsConfig` struct in config
  - Default paths, timeouts, retry settings
- [x] Implemented `radarr` CLI command
  - Dry-run mode
  - Configurable limit and parallel downloads
  - Force re-download option
  - Verbose output
  - Statistics summary
- [x] Implemented `sonarr` CLI command
  - Dry-run mode
  - Series ID filtering
  - Configurable limit and parallel downloads
  - Force re-download option
  - Verbose output
  - Statistics summary
- [x] Updated `config.yml.example` with download settings

### In Progress
- [ ] Unit tests for downloader service
- [ ] Unit tests for TMDB matcher functions
- [ ] Integration tests for full workflows

### Remaining Work
- [ ] Implement parallel download support (currently sequential)
- [ ] Add progress bar library (e.g., `cheggaaa/pb`)
- [ ] Error log file generation
- [ ] Disk space pre-check before download
- [ ] Resume capability for interrupted downloads
- [ ] Documentation updates
- [ ] Performance testing with large datasets

### Known Issues
- Parallel downloads not yet implemented (flag accepted but not used)
- TVDB ID used as proxy for TMDB ID in Sonarr - may need TVDBâ†’TMDB mapping
- Filename sanitization implemented but may need edge case improvements
- No bandwidth throttling or rate limiting
- Episode titles not yet fetched from Sonarr API (using S##E## format only)
- Path compatibility tested on Linux/macOS, Windows testing needed
