services:
  postgres:
    image: postgres:18-alpine
    container_name: stalkeer-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-stalkeer}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Optional: Init scripts
      # - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - stalkeer-network

  stalkeer-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-unknown}
        DATE: ${DATE:-unknown}
    container_name: stalkeer-server
    ports:
      - "${API_PORT:-8080}:8080"
      - "${ADMIN_PORT:-8081}:8081"
    depends_on:
      postgres:
        condition: service_healthy
    command: ["./stalkeer", "server"]
    volumes:
      # Configuration (use environment-specific config)
      - ./config.yml:/app/config/config.yml:ro
      # M3U playlist directory
      - ./m3u_playlist:/app/m3u_playlist:ro
      # Downloads directory
      - ${DOWNLOADS_DIR:-./data/downloads}:/app/data/downloads
      # Temp directory
      - ${TEMP_DIR:-./data/temp}:/app/data/temp
    environment:
      # Database connection (override config.yml)
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - DB_NAME=${DB_NAME:-stalkeer}
      - DB_SSLMODE=${DB_SSLMODE:-disable}
      
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - API_PORT=${API_PORT:-8080}
      
      # TMDB API (if needed)
      - TMDB_API_KEY=${TMDB_API_KEY:-}
      
      # Radarr/Sonarr
      - RADARR_URL=${RADARR_URL:-http://radarr:7878}
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      - SONARR_URL=${SONARR_URL:-http://sonarr:8989}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - stalkeer-network
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M


  process:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-unknown}
        DATE: ${DATE:-unknown}
    container_name: stalkeer-process
    depends_on:
      postgres:
        condition: service_healthy
    command: ["./stalkeer", "process", "--config", "/app/config/config.yml"]
    volumes:
      # Configuration (use environment-specific config)
      - ./config.yml:/app/config/config.yml:ro
      # M3U playlist directory
      - ./m3u_playlist:/app/m3u_playlist:ro
      # Downloads directory
      - ${DOWNLOADS_DIR:-./data/downloads}:/app/data/downloads
      # Temp directory
      - ${TEMP_DIR:-./data/temp}:/app/data/temp
    environment:
      # Database connection (override config.yml)
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - DB_NAME=${DB_NAME:-stalkeer}
      - DB_SSLMODE=${DB_SSLMODE:-disable}
      
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - API_PORT=${API_PORT:-8080}
      
      # TMDB API (if needed)
      - TMDB_API_KEY=${TMDB_API_KEY:-}
      
      # Radarr/Sonarr
      - RADARR_URL=${RADARR_URL:-http://radarr:7878}
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      - SONARR_URL=${SONARR_URL:-http://sonarr:8989}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
    # healthcheck:
    #   test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 10s
    restart: no
    networks:
      - stalkeer-network
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  sonarr-sync:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-unknown}
        DATE: ${DATE:-unknown}
    container_name: stalkeer-sonarr-sync
    depends_on:
      postgres:
        condition: service_healthy
    command: ["./stalkeer", "sonarr", "--config", "/app/config/config.yml"]
    volumes:
      # Configuration (use environment-specific config)
      - ./config.yml:/app/config/config.yml:ro
      # M3U playlist directory
      - ./m3u_playlist:/app/m3u_playlist:ro
      # Downloads directory
      - ${DOWNLOADS_DIR:-./data/downloads}:/app/data/downloads
      # Temp directory
      - ${TEMP_DIR:-./data/temp}:/app/data/temp
    environment:
      # Database connection (override config.yml)
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - DB_NAME=${DB_NAME:-stalkeer}
      - DB_SSLMODE=${DB_SSLMODE:-disable}
      
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - API_PORT=${API_PORT:-8080}
      
      # TMDB API (if needed)
      - TMDB_API_KEY=${TMDB_API_KEY:-}
      
      # Radarr/Sonarr
      - RADARR_URL=${RADARR_URL:-http://radarr:7878}
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      - SONARR_URL=${SONARR_URL:-http://sonarr:8989}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
    # healthcheck:
    #   test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 10s
    restart: no
    networks:
      - stalkeer-network
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
  resume-downloads:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-unknown}
        DATE: ${DATE:-unknown}
    container_name: stalkeer-resume-downloads
    depends_on:
      postgres:
        condition: service_healthy
    command: ["./stalkeer", "resume-downloads", "--config", "/app/config/config.yml"]
    volumes:
      # Configuration (use environment-specific config)
      - ./config.yml:/app/config/config.yml:ro
      # M3U playlist directory
      - ./m3u_playlist:/app/m3u_playlist:ro
      # Downloads directory
      - ${DOWNLOADS_DIR:-./data/downloads}:/app/data/downloads
      # Temp directory
      - ${TEMP_DIR:-./data/temp}:/app/data/temp
    environment:
      # Database connection (override config.yml)
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - DB_NAME=${DB_NAME:-stalkeer}
      - DB_SSLMODE=${DB_SSLMODE:-disable}
      
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - API_PORT=${API_PORT:-8080}
      
      # TMDB API (if needed)
      - TMDB_API_KEY=${TMDB_API_KEY:-}
      
      # Radarr/Sonarr
      - RADARR_URL=${RADARR_URL:-http://radarr:7878}
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      - SONARR_URL=${SONARR_URL:-http://sonarr:8989}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
    # healthcheck:
    #   test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 10s
    restart: no
    networks:
      - stalkeer-network
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # DEVELOPMENT purpose only
  ## Optional Prowlarr service for indexer management
  # prowlarr:
  #   image: lscr.io/linuxserver/prowlarr:latest
  #   container_name: stalkeer-prowlarr
  #   environment:
  #     - PUID=${PUID:-1000}
  #     - PGID=${PGID:-1000}
  #     - TZ=${TZ:-Etc/UTC}
  #   volumes:
  #     - ./data/prowlarr:/config
  #   ports:
  #     - "${PROWLARR_PORT:-9696}:9696"
  #   restart: unless-stopped
  #   networks:
  #     - stalkeer-network

  # DEVELOPMENT purpose only
  ## Sonarr service for managing TV show downloads
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: stalkeer-sonarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UID=${UID:-1000}
      - GID=${GID:-1000}
      - TZ=${TZ:-Etc/UTC}
    volumes:
      - ./data/sonarr:/config
      - ./data/downloads:/downloads
    ports:
      - "${SONARR_PORT:-8989}:8989"
    restart: unless-stopped
    networks:
      - stalkeer-network

  # DEVELOPMENT purpose only
  ## Radarr service for managing movie downloads
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: stalkeer-radarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}
    volumes:
      - ./data/radarr:/config
      - ./data/downloads:/downloads
    ports:
      - "${RADARR_PORT:-7878}:7878"
    restart: unless-stopped
    networks:
      - stalkeer-network

  # DEVELOPMENT purpose only
  # ## Optional web server for streaming (testing)
  web:
    image: nginx:alpine
    container_name: stalkeer-web
    ports:
      - "${WEB_PORT:-8008}:80"
    volumes:
      - ./webserver/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./webserver/html:/usr/share/nginx/html
    restart: unless-stopped
    networks:
      - stalkeer-network

volumes:
  postgres_data:
    driver: local

networks:
  stalkeer-network:
    driver: bridge
