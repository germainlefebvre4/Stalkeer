# YAML anchors for common configurations
x-stalkeer-build: &stalkeer-build
  context: .
  dockerfile: Dockerfile
  args:
    VERSION: ${VERSION:-dev}
    COMMIT: ${COMMIT:-unknown}
    DATE: ${DATE:-unknown}

x-stalkeer-volumes: &stalkeer-volumes
  - ./config.yml:/app/config/config.yml:ro
  - ./m3u_playlist:/app/m3u_playlist:ro
  - ${DOWNLOADS_DIR:-./data/downloads}:/app/data/downloads
  - ${TEMP_DIR:-./data/temp}:/app/data/temp
  - ./data/downloads/movies:/app/data/downloads/movies
  - ./data/downloads/movies:/app/data/downloads/tvshows

x-stalkeer-environment: &stalkeer-environment
  DB_HOST: ${DB_HOST:-postgres}
  DB_PORT: ${DB_PORT:-5432}
  DB_USER: ${DB_USER:-postgres}
  DB_PASSWORD: ${DB_PASSWORD:-postgres}
  DB_NAME: ${DB_NAME:-stalkeer}
  DB_SSLMODE: ${DB_SSLMODE:-disable}
  LOG_LEVEL: ${LOG_LEVEL:-info}
  API_PORT: ${API_PORT:-8080}
  TMDB_API_KEY: ${TMDB_API_KEY:-}
  RADARR_URL: ${RADARR_URL:-http://radarr:7878}
  RADARR_API_KEY: ${RADARR_API_KEY:-}
  SONARR_URL: ${SONARR_URL:-http://sonarr:8989}
  SONARR_API_KEY: ${SONARR_API_KEY:-}
  PUID: ${PUID:-1000}
  PGID: ${PGID:-1000}
  TZ: ${TZ:-Etc/UTC}

x-stalkeer-depends-on: &stalkeer-depends-on
  postgres:
    condition: service_healthy

x-stalkeer-resources: &stalkeer-resources
  resources:
    limits:
      cpus: '2.0'
      memory: 2G
    reservations:
      cpus: '0.5'
      memory: 512M

x-linuxserver-environment: &linuxserver-environment
  PUID: ${PUID:-1000}
  PGID: ${PGID:-1000}
  TZ: ${TZ:-Etc/UTC}

services:
  postgres:
    image: postgres:18-alpine
    container_name: stalkeer-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-stalkeer}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      # Optional: Init scripts
      # - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - stalkeer-network

  stalkeer-server:
    build: *stalkeer-build
    image: germainlefebvre4/stalkeer:${VERSION:-dev}
    container_name: stalkeer-server
    command: ["./stalkeer", "server"]
    ports:
      - "${API_PORT:-8080}:8080"
      - "${ADMIN_PORT:-8081}:8081"
    depends_on: *stalkeer-depends-on
    volumes: *stalkeer-volumes
    environment: *stalkeer-environment
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - stalkeer-network
    deploy: *stalkeer-resources

  process:
    build: *stalkeer-build
    image: germainlefebvre4/stalkeer:${VERSION:-dev}
    container_name: stalkeer-process
    command: ["./stalkeer", "process", "--config", "/app/config/config.yml"]
    depends_on: *stalkeer-depends-on
    volumes: *stalkeer-volumes
    environment: *stalkeer-environment
    restart: no
    networks:
      - stalkeer-network
    deploy: *stalkeer-resources

  sonarr-sync:
    build: *stalkeer-build
    image: germainlefebvre4/stalkeer:${VERSION:-dev}
    container_name: stalkeer-sonarr-sync
    command: ["./stalkeer", "sonarr", "--config", "/app/config/config.yml"]
    depends_on: *stalkeer-depends-on
    volumes: *stalkeer-volumes
    environment: *stalkeer-environment
    restart: no
    networks:
      - stalkeer-network
    deploy: *stalkeer-resources

  resume-downloads:
    build: *stalkeer-build
    image: germainlefebvre4/stalkeer:${VERSION:-dev}
    container_name: stalkeer-resume-downloads
    command: ["./stalkeer", "resume-downloads", "--config", "/app/config/config.yml"]
    depends_on: *stalkeer-depends-on
    volumes: *stalkeer-volumes
    environment: *stalkeer-environment
    restart: no
    networks:
      - stalkeer-network
    deploy: *stalkeer-resources

  # DEVELOPMENT purpose only
  # sonarr:
  #   image: lscr.io/linuxserver/sonarr:latest
  #   container_name: stalkeer-sonarr
  #   environment:
  #     <<: *linuxserver-environment
  #     UID: ${UID:-1000}
  #     GID: ${GID:-1000}
  #   volumes:
  #     - ./data/sonarr:/config
  #     - ./data/downloads:/downloads
  #   ports:
  #     - "${SONARR_PORT:-8989}:8989"
  #   restart: unless-stopped
  #   networks:
  #     - stalkeer-network

  # radarr:
  #   image: lscr.io/linuxserver/radarr:latest
  #   container_name: stalkeer-radarr
  #   environment: *linuxserver-environment
  #   volumes:
  #     - ./data/radarr:/config
  #     - ./data/downloads:/downloads
  #   ports:
  #     - "${RADARR_PORT:-7878}:7878"
  #   restart: unless-stopped
  #   networks:
  #     - stalkeer-network

  # web:
  #   image: nginx:alpine
  #   container_name: stalkeer-web
  #   ports:
  #     - "${WEB_PORT:-8008}:80"
  #   volumes:
  #     - ./webserver/nginx.conf:/etc/nginx/conf.d/default.conf
  #     - ./webserver/html:/usr/share/nginx/html
  #   restart: unless-stopped
  #   networks:
  #     - stalkeer-network

volumes:
  postgres_data:
    driver: local

networks:
  stalkeer-network:
    driver: bridge
