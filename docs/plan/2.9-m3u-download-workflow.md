---
goal: Implement M3U Playlist Download and Archive Management
version: 1.0
date_created: 2026-02-03
last_updated: 2026-02-04
owner: AI Agent
status: 'Completed'
tags: ['feature', 'core', 'm3u', 'download', 'archive']
---

# M3U Download Workflow Implementation Plan

![Status: Completed](https://img.shields.io/badge/status-Completed-brightgreen)

Implement functionality to download M3U playlist files from remote sources, save them to the configured `m3u.file_path` location, and manage archive rotation to prevent clutter. This enables automatic playlist updates and historical tracking of playlist changes over time.

## 1. Requirements & Constraints

**Requirements**

- **REQ-001**: Download M3U playlist file from a configurable remote URL to `m3u.file_path` location
- **REQ-002**: Create timestamped archive copy of each downloaded M3U file
- **REQ-003**: Maintain archive of the last 5 M3U playlist files in a separate archive directory
- **REQ-004**: Automatically rotate and delete old M3U archive files beyond the retention limit (keep last 5)
- **REQ-005**: Support both one-time download and scheduled updates (configurable interval)
- **REQ-006**: Validate downloaded M3U file format before accepting it
- **REQ-007**: Preserve the original M3U file if download fails
- **REQ-008**: Log all download attempts, successes, and failures
- **REQ-009**: Support HTTP/HTTPS URLs with authentication if needed
- **REQ-010**: Handle network errors gracefully with retry mechanism
- **REQ-011**: Replace `m3u.file_path` file atomically after successful download and validation

**Security Requirements**

- **SEC-001**: Validate file size limits to prevent disk exhaustion attacks
- **SEC-002**: Validate Content-Type header to ensure M3U format
- **SEC-003**: Support secure HTTPS connections with certificate validation
- **SEC-004**: Sanitize filenames to prevent path traversal attacks

**Constraints**

- **CON-001**: Must use Go standard library `net/http` for downloads
- **CON-002**: Archive directory must be configurable via `config.yml`
- **CON-003**: Downloaded file must be saved to `m3u.file_path` as specified in configuration
- **CON-004**: Must integrate with existing error handling and logging systems
- **CON-005**: Must not block other application operations during download
- **CON-006**: Maximum file size limit of 500MB (configurable)

**Guidelines**

- **GUD-001**: Use consistent timestamp format (RFC3339) for archived filenames
- **GUD-002**: Implement atomic file operations to prevent corruption
- **GUD-003**: Provide CLI command for manual download trigger
- **GUD-004**: Log download progress for large files

**Patterns**

- **PAT-001**: Follow existing retry pattern from `internal/retry` package
- **PAT-002**: Use circuit breaker pattern for remote URL availability
- **PAT-003**: Follow existing logging patterns from `internal/logger`
- **PAT-004**: Use existing configuration patterns from `internal/config`

## 2. Implementation Steps

### Implementation Phase 1: Configuration and Data Structures

- GOAL-001: Set up configuration schema and data structures for M3U download management

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-001 | Add M3U download configuration to `config.yml.example` including: `m3u.download.enabled`, `m3u.download.url`, `m3u.download.archive_dir`, `m3u.download.retention_count`, `m3u.download.max_file_size_mb`, `m3u.download.timeout_seconds`, `m3u.download.retry_attempts` | ✅ | 2026-02-03 |
| TASK-002 | Update `internal/config/config.go` to include M3UDownloadConfig struct with fields: Enabled, URL, ArchiveDir, RetentionCount, MaxFileSizeMB, TimeoutSeconds, RetryAttempts, AuthUsername, AuthPassword, ScheduleEnabled, IntervalHours | ✅ | 2026-02-03 |
| TASK-003 | Add validation logic in config loader to ensure required fields are set when download is enabled (URL and m3u.file_path must be set) | ✅ | 2026-02-03 |
| TASK-004 | Create `internal/m3udownloader` package directory structure | ✅ | 2026-02-03 |

### Implementation Phase 2: Download Implementation

- GOAL-002: Implement core M3U playlist download functionality with validation and error handling

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-005 | Create `internal/m3udownloader/downloader.go` with Downloader struct containing HTTP client, config, logger, retry handler, and circuit breaker | ✅ | 2026-02-03 |
| TASK-006 | Implement `NewDownloader(cfg *config.M3UDownloadConfig, logger *logger.Logger)` constructor function | ✅ | 2026-02-03 |
| TASK-007 | Implement `Download(ctx context.Context, url string, destPath string) error` method with HTTP GET request, size validation, content-type checking, and atomic file write to destPath | ✅ | 2026-02-03 |
| TASK-008 | Integrate circuit breaker from `internal/circuitbreaker` for remote URL reliability | ✅ | 2026-02-03 |
| TASK-009 | Integrate retry mechanism from `internal/retry` for transient failures | ✅ | 2026-02-03 |
| TASK-010 | Implement `validateM3UContent(data []byte) error` to verify basic M3U format (starts with `#EXTM3U`) | ✅ | 2026-02-03 |
| TASK-011 | Add progress logging for downloads larger than 10MB | ✅ | 2026-02-03 |
| TASK-012 | Handle HTTP authentication headers if credentials are provided in config | ✅ | 2026-02-03 |
| TASK-013 | Implement atomic write: download to temp file, validate, then rename to `m3u.file_path` | ✅ | 2026-02-03 |

### Implementation Phase 3: Archive Management

- GOAL-003: Implement M3U file archiving with rotation and cleanup

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-014 | Create `internal/m3udownloader/archive.go` with ArchiveManager struct | ✅ | 2026-02-03 |
| TASK-015 | Implement `ArchiveFile(sourcePath string) (string, error)` to copy M3U content to archive with timestamped filename (format: `playlist_YYYYMMDD_HHMMSS.ffffff.m3u`) | ✅ | 2026-02-03 |
| TASK-016 | Archive file should be created AFTER successful download to `m3u.file_path` | ✅ | 2026-02-03 |
| TASK-017 | Implement `ListArchiveFiles() ([]ArchiveInfo, error)` to get sorted list of archived M3U files by modification time (newest first) | ✅ | 2026-02-03 |
| TASK-018 | Implement `RotateArchive(retentionCount int) error` to delete oldest files beyond retention limit | ✅ | 2026-02-03 |
| TASK-019 | Implement `GetLatestArchive() (*ArchiveInfo, error)` to retrieve the most recent archived M3U file | ✅ | 2026-02-03 |
| TASK-020 | Add file permission checks to ensure archive directory is writable | ✅ | 2026-02-03 |
| TASK-021 | Implement safe cleanup with error handling for file deletion failures | ✅ | 2026-02-03 |

### Implementation Phase 4: CLI Integration

- GOAL-004: Provide CLI commands for manual M3U playlist download and archive management

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-022 | Create `download-m3u` command in `cmd/main.go` using Cobra | ✅ | 2026-02-03 |
| TASK-023 | Command workflow: download to temp → validate → save to `m3u.file_path` → archive → rotate | ✅ | 2026-02-03 |
| TASK-024 | Add `--url` flag to override configured URL for one-time downloads | ✅ | 2026-02-03 |
| TASK-025 | Add `--no-archive` flag to disable automatic archiving | ✅ | 2026-02-03 |
| TASK-026 | Implement command handler to call downloader, save to `m3u.file_path`, archive copy, and rotate old archive files | ✅ | 2026-02-03 |
| TASK-027 | Add command output showing download progress, file size, and saved location | ✅ | 2026-02-03 |
| TASK-028 | Create `list-m3u-archives` command to display archived M3U files with timestamps and sizes | ✅ | 2026-02-03 |
| TASK-029 | Create `cleanup-m3u-archives` command to manually trigger archive rotation with `--retention` flag | ✅ | 2026-02-03 |

### Implementation Phase 5: Scheduled Updates (Optional)

- GOAL-005: Enable automatic scheduled M3U playlist updates

**Note**: This phase was deferred as optional. Configuration fields were added to support future implementation, but the scheduler itself was not implemented in this release. Users can use cron jobs or similar tools for scheduled downloads.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-030 | Add `m3u.download.schedule_enabled` and `m3u.download.interval_hours` to config | ✅ | 2026-02-03 |
| TASK-031 | Create `internal/m3udownloader/scheduler.go` with background scheduler using time.Ticker | ⏸️ | Deferred |
| TASK-032 | Implement graceful shutdown integration with `internal/shutdown` package | ⏸️ | Deferred |
| TASK-033 | Add scheduler start in main application startup if schedule is enabled | ⏸️ | Deferred |
| TASK-034 | Scheduler must update `m3u.file_path`, create archive, and rotate on each run | ⏸️ | Deferred |
| TASK-035 | Log scheduled download attempts and results | ⏸️ | Deferred |
| TASK-036 | Implement jitter in schedule to avoid thundering herd if multiple instances run | ⏸️ | Deferred |

### Implementation Phase 6: Testing

- GOAL-006: Ensure comprehensive test coverage for M3U download and archive functionality

| Task | Description | Completed | Date |✅ | 2026-02-03 |
| TASK-038 | Mock HTTP server for testing successful downloads, 404 errors, timeouts, and invalid content | ✅ | 2026-02-03 |
| TASK-039 | Test retry mechanism with transient failures | ✅ | 2026-02-03 |
| TASK-040 | Test circuit breaker behavior with repeated failures | ✅ | 2026-02-03 |
| TASK-041 | Test atomic file write behavior (temp file → validate → rename to m3u.file_path) | ✅ | 2026-02-03 |
| TASK-042 | Create `internal/m3udownloader/archive_test.go` with tests for archive, list, rotate, and cleanup | ✅ | 2026-02-03 |
| TASK-043 | Test archive rotation with different retention counts (0, 1, 5, 10) | ✅ | 2026-02-03 |
| TASK-044 | Test archive copy and cleanup | ✅ | 2026-02-03 |
| TASK-045 | Test edge cases: empty directory, non-existent directory | ✅ | 2026-02-03 |
| TASK-046 | Integration test for full download → save to m3u.file_path → archive → rotate workflow | ✅ | 2026-02-03 |
| TASK-047 | Test M3U validation with valid and invalid content | ✅ | 2026-02-03 |
| TASK-048 | Test that original m3u.file_path is preserved if download fails | ✅ | 2026-02-03e → rotate workflow | | |
| TASK-047 | Test M3U validation with valid and invalid content | | |
| TASK-048 | Test that original m3u.file_path is preserved if download fails | | |

### Implementation Phase 7: Documentation

- GOAL-007: Document M3U download configuration and usage

| Task | Description | Completed | Date |✅ | 2026-02-03 |
| TASK-050 | Document all configuration options in config.yml.example with comments | ✅ | 2026-02-03 |
| TASK-051 | Create docs/M3U-DOWNLOAD.md with comprehensive feature documentation | ✅ | 2026-02-03 |
| TASK-052 | Document the workflow: download URL → m3u.file_path → archive copy → rotation | ✅ | 2026-02-03 |
| TASK-053 | Add troubleshooting section for common download issues (network errors, authentication, timeouts, etc.) | ✅ | 2026-02-03 |
| TASK-054 | Document archive rotation behavior and retention policies | ✅ | 2026-02-03 copy → rotation | | |
| TASK-053 | Add troubleshooting section for common download issues (network errors, authentication, etc.) | | |
| TASK-054 | Document archive rotation behavior and retention policies | | |

## 3. Alternatives

- **ALT-001**: Use cron job or systemd timer instead of built-in scheduler
  - **Rejected**: Built-in scheduler provides better integration and simpler deployment
  
- **ALT-002**: Store archive metadata in database instead of filesystem
  - **Rejected**: Filesystem is simpler and sufficient for this use case; database would add unnecessary complexity
  
- **ALT-003**: Use rsync or wget for downloads instead of Go HTTP client
  - **Rejected**: External dependencies complicate deployment; Go HTTP client is sufficient and provides better error handling integration
  
- **ALT-004**: Store unlimited archive history
  - **Rejected**: Disk space constraints require rotation; 5 files provides sufficient history for debugging

- **ALT-005**: Use content hashing to skip redundant downloads
  - **Deferred**: Can be added in future enhancement; initial version always downloads to ensure freshness

- **ALT-006**: Download directly to m3u.file_path without temp file
  - **Rejected**: Atomic operations via temp file prevent corruption if download fails or is interrupted

## 4. Dependencies

- **DEP-001**: `internal/config` package for configuration management
- **DEP-002**: `internal/logger` package for logging
- **DEP-003**: `internal/retry` package for retry mechanism
- **DEP-004**: `internal/circuitbreaker` package for circuit breaker pattern
- **DEP-005**: `internal/shutdown` package for graceful shutdown (if scheduler is implemented)
- **DEP-006**: `github.com/spf13/cobra` for CLI commands
- **DEP-007**: `net/http` standard library for HTTP client
- **DEP-008**: `os`, `io`, `path/filepath` standard libraries for file operations

## 5. Files

- **FILE-001**: `config.yml.example` - Add M3U download configuration section
- **FILE-002**: `internal/config/config.go` - Add M3UDownloadConfig struct and validation
- **FILE-003**: `internal/m3udownloader/downloader.go` - Core download implementation to m3u.file_path
- **FILE-004**: `internal/m3udownloader/archive.go` - Archive management implementation
- **FILE-005**: `internal/m3udownloader/scheduler.go` - Scheduled update implementation (optional)
- **FILE-006**: `internal/m3udownloader/downloader_test.go` - Unit tests for downloader
- **FILE-007**: `internal/m3udownloader/archive_test.go` - Unit tests for archive manager
- **FILE-008**: `cmd/main.go` - Add download-m3u, list-m3u-archives, cleanup-m3u-archives commands
- **FILE-009**: `README.md` - Update with M3U download documentation
- **FILE-010**: `docs/M3U-DOWNLOAD.md` - Detailed feature documentation (new file)

## 6. Testing

- **TEST-001**: Unit test for successful M3U download from mock HTTP server to m3u.file_path
- **TEST-002**: Unit test for download failure handling (404, timeout, connection refused)
- **TEST-003**: Unit test for file size limit enforcement
- **TEST-004**: Unit test for content-type validation
- **TEST-005**: Unit test for M3U format validation (valid and invalid content)
- **TEST-006**: Unit test for retry mechanism with transient failures
- **TEST-007**: Unit test for circuit breaker behavior
- **TEST-008**: Unit test for atomic file write (temp → validate → rename to m3u.file_path)
- **TEST-009**: Unit test for archive creation with timestamped filename
- **TEST-010**: Unit test for archive rotation with various retention counts
- **TEST-011**: Unit test for listing archived files in chronological order
- **TEST-012**: Unit test for getting latest archive file
- **TEST-013**: Unit test for handling permission errors during archive operations
- **TEST-014**: Integration test for complete download → save to m3u.file_path → archive → rotate workflow
- **TEST-015**: Integration test for CLI commands (download-m3u, list-m3u-archives, cleanup-m3u-archives)
- **TEST-016**: Test that m3u.file_path is not modified if download fails validation
- **TEST-017**: Manual test for scheduled download (if scheduler is implemented)

## 7. Risks & Assumptions

**Risks**

- **RISK-001**: Remote M3U URL becomes unavailable or changes without notice
  - **Mitigation**: Preserve last known good file at m3u.file_path; implement circuit breaker to prevent repeated failures
  
- **RISK-002**: Downloaded file is corrupted or malformed
  - **Mitigation**: Validate M3U format before replacing m3u.file_path; use atomic operations via temp file
  
- **RISK-003**: Disk space exhaustion from large M3U files or failed rotation
  - **Mitigation**: Enforce file size limits; implement robust rotation with cleanup verification
  
- **RISK-004**: Network timeouts during download of large files
  - **Mitigation**: Configurable timeout; retry mechanism with exponential backoff
  
- **RISK-005**: Authentication requirements change on remote server
  - **Mitigation**: Support configurable authentication headers; clear error messages for auth failures

- **RISK-006**: Concurrent access to m3u.file_path during update
  - **Mitigation**: Atomic rename operation prevents readers from seeing partial file; use file locking if needed

**Assumptions**

- **ASSUMPTION-001**: M3U playlist files are served over HTTP/HTTPS (not FTP or other protocols)
- **ASSUMPTION-002**: M3U files are reasonably sized (<500MB by default)
- **ASSUMPTION-003**: M3U playlist structure remains consistent over time
- **ASSUMPTION-004**: Network connectivity is generally available (not air-gapped environment)
- **ASSUMPTION-005**: Archive directory has sufficient disk space (at least 5x max file size)
- **ASSUMPTION-006**: File system supports atomic rename operations
- **ASSUMPTION-007**: M3U URL does not require complex OAuth or session-based authentication
- **ASSUMPTION-008**: `m3u.file_path` directory is writable and has sufficient space
- **ASSUMPTION-009**: Concurrent reads of m3u.file_path during download are handled by atomic operations

## 8. Related Specifications / Further Reading

- [Task 2.1: M3U Parser Implementation](2.1-m3u-parser.md) - Related M3U parsing functionality that reads from m3u.file_path
- [Task 1.2: Configuration Management](1.2-configuration-management.md) - Configuration system being extended
- [Task 3.1: Error Handling](3.1-error-handling.md) - Error handling patterns to follow
- [Task 5.1: Modularized Logging System](5.1-modularized-logging-system.md) - Logging patterns to follow
- [M3U Format Specification](https://en.wikipedia.org/wiki/M3U) - M3U playlist format reference
- [Go HTTP Client Best Practices](https://go.dev/doc/articles/wiki/) - HTTP client implementation guidance
